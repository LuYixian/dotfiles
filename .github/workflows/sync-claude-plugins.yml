name: Sync Claude Plugins
on:
  schedule:
    - cron: "0 6 * * 0" # Weekly on Sunday at 06:00 UTC
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no upstream changes"
        type: boolean
        default: false
permissions:
  contents: write
  pull-requests: write
env:
  WSHOBSON_REPO: wshobson/agents
  SUPERPOWERS_REPO: obra/superpowers
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install tools
        run: |
          # yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          # shfmt
          sudo wget -qO /usr/local/bin/shfmt https://github.com/mvdan/sh/releases/latest/download/shfmt_v3.8.0_linux_amd64
          sudo chmod +x /usr/local/bin/shfmt
      - name: Get upstream SHAs
        id: upstream
        run: |
          echo "wshobson=$(gh api repos/${{ env.WSHOBSON_REPO }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
          echo "superpowers=$(gh api repos/${{ env.SUPERPOWERS_REPO }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download upstream repos
        run: |
          curl -sL "https://github.com/${{ env.WSHOBSON_REPO }}/archive/main.tar.gz" | tar xz
          mv agents-main /tmp/wshobson-agents
          curl -sL "https://github.com/${{ env.SUPERPOWERS_REPO }}/archive/main.tar.gz" | tar xz
          mv superpowers-main /tmp/superpowers
      - name: Sync plugin files
        run: |
          chmod +x .github/scripts/sync-claude-plugins.sh
          .github/scripts/sync-claude-plugins.sh /tmp/wshobson-agents /tmp/superpowers
      - name: Scan plugin metadata
        id: scan
        env:
          REPO_DIR: /tmp/wshobson-agents
          OUTPUT: /tmp/plugins.json
        run: |
          chmod +x .github/scripts/update-plugin-metadata.sh
          .github/scripts/update-plugin-metadata.sh scan

          # Generate prompt and check if AI generation is needed
          prompt=$(.github/scripts/update-plugin-metadata.sh prompt)
          if [[ -n "$prompt" ]]; then
            echo "needs_ai=true" >> $GITHUB_OUTPUT
            # Use heredoc for multiline output
            {
              echo "prompt<<EOF"
              echo "$prompt"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "needs_ai=false" >> $GITHUB_OUTPUT
          fi
      - name: Generate keywords with Gemini
        if: steps.scan.outputs.needs_ai == 'true'
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.19
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-3-flash-preview
          prompt: ${{ steps.scan.outputs.prompt }}
      - name: Apply AI-generated keywords
        if: steps.scan.outputs.needs_ai == 'true'
        env:
          OUTPUT: /tmp/plugins.json
          AI_RESPONSE: ${{ steps.gemini.outputs.summary }}
        run: |
          echo "$AI_RESPONSE" | .github/scripts/update-plugin-metadata.sh apply
      - name: Update claude.yaml
        run: |
          yq -i -P '.claude.wshobson.registry = load("/tmp/plugins.json")' .chezmoidata/claude.yaml
      - name: Format files
        run: |
          npx prettier --write "dot_claude/**/*.{md,json,js,ts}" ".chezmoidata/*.yaml"
          find dot_claude -name "*.sh" -exec shfmt -w {} \;
      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            added=$(git status --porcelain | grep -c "^?" || echo 0)
            modified=$(git status --porcelain | grep -c "^ M\|^M" || echo 0)
            deleted=$(git status --porcelain | grep -c "^ D\|^D" || echo 0)
            echo "added=$added" >> $GITHUB_OUTPUT
            echo "modified=$modified" >> $GITHUB_OUTPUT
            echo "deleted=$deleted" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore(claude): sync plugins from upstream"
          title: "chore(claude): sync plugins (${{ steps.upstream.outputs.wshobson }}/${{ steps.upstream.outputs.superpowers }})"
          branch: chore/sync-claude-plugins
          delete-branch: true
          labels: dependencies,claude,automation
          body: |
            ## Plugin Sync

            | Source | SHA |
            |--------|-----|
            | [wshobson/agents](https://github.com/${{ env.WSHOBSON_REPO }}) | `${{ steps.upstream.outputs.wshobson }}` |
            | [obra/superpowers](https://github.com/${{ env.SUPERPOWERS_REPO }}) | `${{ steps.upstream.outputs.superpowers }}` |

            ### Changes
            - Added: ${{ steps.changes.outputs.added }} files
            - Modified: ${{ steps.changes.outputs.modified }} files
            - Deleted: ${{ steps.changes.outputs.deleted }} files

            ### What's synced
            - Plugin files (agents, commands, skills)
            - Plugin metadata (keywords, descriptions)

            ---
            *Auto-generated by [sync-claude-plugins](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
      - name: Summary
        run: |
          echo "## Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "- wshobson SHA: \`${{ steps.upstream.outputs.wshobson }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- superpowers SHA: \`${{ steps.upstream.outputs.superpowers }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Changes: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
