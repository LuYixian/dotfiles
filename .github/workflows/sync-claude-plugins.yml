name: Sync Claude Plugins
on:
  schedule:
    - cron: "0 6 * * 0" # Weekly on Sunday at 06:00 UTC
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no changes detected"
        type: boolean
        default: false
permissions:
  contents: write
  pull-requests: write
env:
  WSHOBSON_REPO: wshobson/agents
  SUPERPOWERS_REPO: obra/superpowers
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Get current manifest SHAs
        id: current
        run: |
          if [[ -f dot_claude/.plugin-manifest.yaml ]]; then
            echo "wshobson_sha=$(yq -r '.sync.wshobson_agents_sha // "none"' dot_claude/.plugin-manifest.yaml)" >> $GITHUB_OUTPUT
            echo "superpowers_sha=$(yq -r '.sync.superpowers_sha // "none"' dot_claude/.plugin-manifest.yaml)" >> $GITHUB_OUTPUT
          else
            echo "wshobson_sha=none" >> $GITHUB_OUTPUT
            echo "superpowers_sha=none" >> $GITHUB_OUTPUT
          fi
      - name: Get latest upstream SHAs
        id: upstream
        run: |
          echo "wshobson_sha=$(gh api repos/${{ env.WSHOBSON_REPO }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
          echo "superpowers_sha=$(gh api repos/${{ env.SUPERPOWERS_REPO }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Check for updates
        id: check
        run: |
          if [[ "${{ inputs.force_sync }}" == "true" ]]; then
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "reason=Force sync requested" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.current.outputs.wshobson_sha }}" != "${{ steps.upstream.outputs.wshobson_sha }}" ]]; then
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "reason=wshobson/agents updated (${{ steps.current.outputs.wshobson_sha }} -> ${{ steps.upstream.outputs.wshobson_sha }})" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.current.outputs.superpowers_sha }}" != "${{ steps.upstream.outputs.superpowers_sha }}" ]]; then
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "reason=obra/superpowers updated (${{ steps.current.outputs.superpowers_sha }} -> ${{ steps.upstream.outputs.superpowers_sha }})" >> $GITHUB_OUTPUT
          else
            echo "needs_sync=false" >> $GITHUB_OUTPUT
            echo "reason=No upstream changes detected" >> $GITHUB_OUTPUT
          fi
      - name: Download wshobson/agents
        if: steps.check.outputs.needs_sync == 'true'
        run: |
          curl -sL "https://github.com/${{ env.WSHOBSON_REPO }}/archive/refs/heads/main.tar.gz" | tar xz
          mv agents-main /tmp/wshobson-agents
          echo "Downloaded wshobson/agents"
      - name: Download obra/superpowers
        if: steps.check.outputs.needs_sync == 'true'
        run: |
          curl -sL "https://github.com/${{ env.SUPERPOWERS_REPO }}/archive/refs/heads/main.tar.gz" | tar xz
          mv superpowers-main /tmp/superpowers
          echo "Downloaded obra/superpowers"
      - name: Sync plugins
        if: steps.check.outputs.needs_sync == 'true'
        run: |
          chmod +x .github/scripts/sync-claude-plugins.sh
          .github/scripts/sync-claude-plugins.sh /tmp/wshobson-agents /tmp/superpowers
      - name: Check for changes
        if: steps.check.outputs.needs_sync == 'true'
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Files changed:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No file changes after sync"
          fi
      - name: Generate PR body
        if: steps.check.outputs.needs_sync == 'true' && steps.changes.outputs.has_changes == 'true'
        id: pr_body
        run: |
          # Count changes by type
          added=$(git status --porcelain | grep -c "^A" || echo 0)
          modified=$(git status --porcelain | grep -c "^M" || echo 0)
          deleted=$(git status --porcelain | grep -c "^D" || echo 0)

          # Get enabled plugins count
          plugin_count=$(yq -r '.claude.enabledPlugins | length' .chezmoidata/claude.yaml)

          cat << EOF > /tmp/pr_body.md
          ## Plugin Sync Summary

          **Trigger:** ${{ steps.check.outputs.reason }}

          ### Changes
          - Added: $added files
          - Modified: $modified files
          - Deleted: $deleted files

          ### Sources
          | Source | Previous | Current |
          |--------|----------|---------|
          | [wshobson/agents](https://github.com/${{ env.WSHOBSON_REPO }}) | \`${{ steps.current.outputs.wshobson_sha }}\` | \`${{ steps.upstream.outputs.wshobson_sha }}\` |
          | [obra/superpowers](https://github.com/${{ env.SUPERPOWERS_REPO }}) | \`${{ steps.current.outputs.superpowers_sha }}\` | \`${{ steps.upstream.outputs.superpowers_sha }}\` |

          ### Enabled Plugins ($plugin_count)
          <details>
          <summary>Click to expand</summary>

          \`\`\`yaml
          $(yq -r '.claude.enabledPlugins[]' .chezmoidata/claude.yaml | sed 's/^/- /')
          \`\`\`
          </details>

          ---
          *This PR was automatically generated by the [sync-claude-plugins](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.*
          EOF
      - name: Create Pull Request
        if: steps.check.outputs.needs_sync == 'true' && steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore(claude): sync plugins from upstream"
          title: "chore(claude): sync plugins (${{ steps.upstream.outputs.wshobson_sha }}/${{ steps.upstream.outputs.superpowers_sha }})"
          branch: chore/sync-claude-plugins
          delete-branch: true
          labels: |
            dependencies
            claude
            automation
          body-path: /tmp/pr_body.md
      - name: Summary
        run: |
          echo "## Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Needs sync:** ${{ steps.check.outputs.needs_sync }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** ${{ steps.check.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check.outputs.needs_sync }}" == "true" ]]; then
            echo "- **Has changes:** ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          fi
