name: Sync Claude Plugins
on:
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no upstream changes"
        type: boolean
        default: false
permissions:
  contents: write
  pull-requests: write
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Install tools
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          # shfmt (get latest version dynamically)
          SHFMT_VERSION=$(gh release view --repo mvdan/sh --json tagName -q '.tagName')
          sudo wget -qO /usr/local/bin/shfmt "https://github.com/mvdan/sh/releases/download/${SHFMT_VERSION}/shfmt_${SHFMT_VERSION}_linux_amd64"
          sudo chmod +x /usr/local/bin/shfmt
      - name: Read repo config
        id: repos
        run: |
          echo "wshobsonAgents=$(yq -r '.claude.wshobsonAgents.repo' .chezmoidata/claude.yaml)" >> $GITHUB_OUTPUT
          echo "superpowers=$(yq -r '.claude.superpowers.repo' .chezmoidata/claude.yaml)" >> $GITHUB_OUTPUT
          echo "anthropicsSkills=$(yq -r '.claude.anthropicsSkills.repo' .chezmoidata/claude.yaml)" >> $GITHUB_OUTPUT
      - name: Get upstream SHAs
        id: upstream
        run: |
          echo "wshobsonAgents=$(gh api repos/${{ steps.repos.outputs.wshobsonAgents }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
          echo "superpowers=$(gh api repos/${{ steps.repos.outputs.superpowers }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
          echo "anthropicsSkills=$(gh api repos/${{ steps.repos.outputs.anthropicsSkills }}/commits/main --jq '.sha' | head -c 7)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download upstream repos
        run: |
          # Extract repo name from path (e.g., "wshobson/agents" -> "agents")
          wshobson_name="${{ steps.repos.outputs.wshobsonAgents }}"
          wshobson_name="${wshobson_name##*/}"
          superpowers_name="${{ steps.repos.outputs.superpowers }}"
          superpowers_name="${superpowers_name##*/}"
          anthropics_name="${{ steps.repos.outputs.anthropicsSkills }}"
          anthropics_name="${anthropics_name##*/}"

          curl -sL "https://github.com/${{ steps.repos.outputs.wshobsonAgents }}/archive/main.tar.gz" | tar xz
          mv "${wshobson_name}-main" /tmp/wshobson-agents
          curl -sL "https://github.com/${{ steps.repos.outputs.superpowers }}/archive/main.tar.gz" | tar xz
          mv "${superpowers_name}-main" /tmp/superpowers
          curl -sL "https://github.com/${{ steps.repos.outputs.anthropicsSkills }}/archive/main.tar.gz" | tar xz
          mv "${anthropics_name}-main" /tmp/anthropics-skills
      - name: Sync plugin files
        run: |
          chmod +x .github/scripts/sync-claude-plugins.sh
          .github/scripts/sync-claude-plugins.sh /tmp/wshobson-agents /tmp/superpowers /tmp/anthropics-skills
      - name: Scan plugin metadata
        id: scan
        env:
          REPO_DIR: /tmp/wshobson-agents
          OUTPUT: /tmp/plugins.json
        run: |
          chmod +x .github/scripts/update-plugin-metadata.sh
          .github/scripts/update-plugin-metadata.sh scan

          # Generate prompt and check if AI generation is needed
          prompt=$(.github/scripts/update-plugin-metadata.sh prompt)
          if [[ -n "$prompt" ]]; then
            echo "needs_ai=true" >> $GITHUB_OUTPUT
            # Use heredoc for multiline output
            {
              echo "prompt<<EOF"
              echo "$prompt"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "needs_ai=false" >> $GITHUB_OUTPUT
          fi
      - name: Generate keywords with OpenRouter
        if: steps.scan.outputs.needs_ai == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_REFERER: https://github.com/${{ github.repository }}
        run: |
          chmod +x .github/scripts/openrouter-query.sh
          echo '${{ steps.scan.outputs.prompt }}' | .github/scripts/openrouter-query.sh > /tmp/ai_response.txt
      - name: Apply AI-generated keywords
        if: steps.scan.outputs.needs_ai == 'true'
        env:
          OUTPUT: /tmp/plugins.json
        run: |
          cat /tmp/ai_response.txt | .github/scripts/update-plugin-metadata.sh apply
      - name: Update claude.yaml
        run: |
          yq -i -P '.claude.wshobsonAgents.registry = load("/tmp/plugins.json")' .chezmoidata/claude.yaml
      - name: Format files
        run: |
          npx prettier --write "dot_claude/**/*.{md,json,js,ts}" ".chezmoidata/*.yaml"
          find dot_claude -name "*.sh" -exec shfmt -w {} \;
      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            added=$(git status --porcelain | grep "^?" | wc -l | tr -d ' ')
            modified=$(git status --porcelain | grep -E "^ M|^M" | wc -l | tr -d ' ')
            deleted=$(git status --porcelain | grep -E "^ D|^D" | wc -l | tr -d ' ')
            echo "added=$added" >> $GITHUB_OUTPUT
            echo "modified=$modified" >> $GITHUB_OUTPUT
            echo "deleted=$deleted" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_PAT }}
          add-paths: |
            dot_claude/
            .chezmoidata/claude.yaml
          commit-message: "chore(claude): sync plugins from upstream"
          title: "chore(claude): sync plugins (${{ steps.upstream.outputs.wshobsonAgents }}/${{ steps.upstream.outputs.superpowers }}/${{ steps.upstream.outputs.anthropicsSkills }})"
          branch: chore/sync-claude-plugins
          delete-branch: true
          labels: dependencies,claude,automation
          body: |
            ## Plugin Sync

            | Source | SHA |
            |--------|-----|
            | [${{ steps.repos.outputs.wshobsonAgents }}](https://github.com/${{ steps.repos.outputs.wshobsonAgents }}) | `${{ steps.upstream.outputs.wshobsonAgents }}` |
            | [${{ steps.repos.outputs.superpowers }}](https://github.com/${{ steps.repos.outputs.superpowers }}) | `${{ steps.upstream.outputs.superpowers }}` |
            | [${{ steps.repos.outputs.anthropicsSkills }}](https://github.com/${{ steps.repos.outputs.anthropicsSkills }}) | `${{ steps.upstream.outputs.anthropicsSkills }}` |

            ### Changes
            - Added: ${{ steps.changes.outputs.added }} files
            - Modified: ${{ steps.changes.outputs.modified }} files
            - Deleted: ${{ steps.changes.outputs.deleted }} files

            ### What's synced
            - Plugin files (agents, commands, skills)
            - Plugin metadata (keywords, descriptions)

            ---
            *Auto-generated by [sync-claude-plugins](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
      - name: Summary
        run: |
          echo "## Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "- wshobsonAgents SHA: \`${{ steps.upstream.outputs.wshobsonAgents }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- superpowers SHA: \`${{ steps.upstream.outputs.superpowers }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- anthropicsSkills SHA: \`${{ steps.upstream.outputs.anthropicsSkills }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Changes: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
