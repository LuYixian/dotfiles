name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pre-commit/action@v3.0.1
        env:
          SKIP: check-nix # Nix checks run in the 'nix' job
  nix:
    name: Nix (${{ matrix.platform }})
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Setup chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
          mkdir -p ~/.config/chezmoi
          cat > ~/.config/chezmoi/chezmoi.toml << EOF
          [data]
          hostname = "ci-host"
          platform = "${{ matrix.platform }}"
          work = false
          private = false
          timezone = "UTC"
          EOF
      - name: Render templates
        run: |
          mkdir -p rendered/modules
          chezmoi execute-template --source . < nix-config/flake.nix.tmpl > rendered/flake.nix
          cp nix-config/.flake-${{ matrix.platform }}.lock rendered/flake.lock
          for f in nix-config/modules/*.tmpl; do
            chezmoi execute-template --source . < "$f" > "rendered/modules/$(basename "${f%.tmpl}")"
          done
          for f in nix-config/modules/*.nix; do
            [ -f "$f" ] && cp "$f" rendered/modules/
          done
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/flakehub-cache-action@v1
      - name: Check Nix formatting (alejandra)
        run: |
          if ! nix run nixpkgs#alejandra -- --check rendered/; then
            echo "::group::Alejandra formatting diff"
            for f in rendered/*.nix rendered/modules/*.nix; do
              [ -f "$f" ] || continue
              cp "$f" "$f.orig"
              nix run nixpkgs#alejandra -- "$f"
              diff "$f.orig" "$f" || true
            done
            exit 1
          fi
      - name: Lint Nix code (statix)
        run: nix run nixpkgs#statix -- check rendered/
      - name: Check flake
        working-directory: rendered
        run: nix flake check --no-build
      - uses: DeterminateSystems/flake-checker-action@v9
        with:
          flake-lock-path: rendered/flake.lock
