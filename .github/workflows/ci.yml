name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pre-commit/action@v3.0.1
        env:
          SKIP: check-nix # Nix checks run in the 'nix' job
  nix:
    name: Nix (${{ matrix.platform }})
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: Setup chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
          mkdir -p ~/.config/chezmoi
          cat > ~/.config/chezmoi/chezmoi.toml << EOF
          [data]
          hostname = "ci-host"
          platform = "${{ matrix.platform }}"
          work = false
          private = false
          timezone = "UTC"
          installMasApps = false
          EOF
      - name: Render templates
        run: |
          # Render to temp directory (avoids Git tracking issues with flakes)
          workdir=$(mktemp -d)
          echo "WORKDIR=$workdir" >> $GITHUB_ENV
          mkdir -p "$workdir/modules"
          chezmoi execute-template --source . < nix-config/flake.nix.tmpl > "$workdir/flake.nix"
          cp nix-config/.flake-${{ matrix.platform }}.lock "$workdir/flake.lock"
          for f in nix-config/modules/*.tmpl; do
            chezmoi execute-template --source . < "$f" > "$workdir/modules/$(basename "${f%.tmpl}")"
          done
          for f in nix-config/modules/*.nix; do
            [ -f "$f" ] && cp "$f" "$workdir/modules/"
          done
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false
          use-gha-cache: true
      - name: Check Nix formatting (alejandra)
        run: |
          if ! nix run nixpkgs#alejandra -- --check "$WORKDIR"; then
            echo "::group::Alejandra formatting diff"
            for f in "$WORKDIR"/*.nix "$WORKDIR"/modules/*.nix; do
              [ -f "$f" ] || continue
              cp "$f" "$f.orig"
              nix run nixpkgs#alejandra -- "$f"
              diff "$f.orig" "$f" || true
            done
            exit 1
          fi
      - name: Lint Nix code (statix)
        run: nix run nixpkgs#statix -- check "$WORKDIR"
      - name: Check flake
        run: nix flake check --no-build "$WORKDIR"
      - uses: DeterminateSystems/flake-checker-action@v12
        with:
          flake-lock-path: ${{ env.WORKDIR }}/flake.lock
