name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false
          use-gha-cache: true
      - name: Install tools
        run: |
          nix profile install nixpkgs#treefmt nixpkgs#shfmt nixpkgs#shellcheck nixpkgs#statix nixpkgs#nixfmt nixpkgs#stylua nixpkgs#selene
      - name: Setup chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
          mkdir -p ~/.config/chezmoi
          cat > ~/.config/chezmoi/chezmoi.toml << EOF
          [data]
          hostname = "ci-host"
          platform = "linux"
          work = false
          private = true
          homeWifiSSIDs = ""
          timezone = "UTC"
          gitUsername = "ci"
          gitEmail = "ci@test.com"
          useEncryption = false
          headless = true
          EOF
      - uses: pre-commit/action@v3.0.1
  nix:
    name: Nix (${{ matrix.platform }})
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - name: Setup chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
          mkdir -p ~/.config/chezmoi
          cat > ~/.config/chezmoi/chezmoi.toml << EOF
          [data]
          hostname = "ci-host"
          platform = "${{ matrix.platform }}"
          work = false
          private = false
          timezone = "UTC"
          installMasApps = false
          EOF
      - name: Render templates
        run: |
          # Render to temp directory (avoids Git tracking issues with flakes)
          workdir=$(mktemp -d)
          echo "WORKDIR=$workdir" >> $GITHUB_ENV
          mkdir -p "$workdir/modules"
          chezmoi execute-template --source . < nix-config/flake.nix.tmpl > "$workdir/flake.nix"
          cp nix-config/.flake-${{ matrix.platform }}.lock "$workdir/flake.lock"
          for f in nix-config/modules/*.tmpl; do
            chezmoi execute-template --source . < "$f" > "$workdir/modules/$(basename "${f%.tmpl}")"
          done
          for f in nix-config/modules/*.nix; do
            [ -f "$f" ] && cp "$f" "$workdir/modules/"
          done
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false
          use-gha-cache: true
      - name: Check flake
        run: nix flake check --no-build "$WORKDIR"
      - uses: DeterminateSystems/flake-checker-action@v12
        with:
          flake-lock-path: ${{ env.WORKDIR }}/flake.lock
