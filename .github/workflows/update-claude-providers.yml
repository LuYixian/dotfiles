name: Update Claude Provider Configs
on:
  workflow_dispatch:
    inputs:
      provider:
        description: "Specific provider to update (or 'all')"
        type: choice
        options:
          - all
          - deepseek
          - kimi
          - glm
          - qwen
          - minimax
          - doubao
        default: "all"
permissions:
  contents: write
  pull-requests: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
      - name: Install dependencies
        env:
          YQ_VERSION: "v4.50.1"
          YQ_SHA256: "c7a1278e6bbc4924f41b56db838086c39d13ee25dcb22089e7fbf16ac901f0d4"
        run: |
          wget -qO /tmp/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          echo "${YQ_SHA256}  /tmp/yq" | sha256sum -c -
          sudo mv /tmp/yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          npm install playwright
          npx playwright install chromium --with-deps
      - name: Fetch documentation with Playwright
        id: fetch
        run: |
          PROVIDER="${{ github.event.inputs.provider || 'all' }}"
          node .github/scripts/fetch-provider-docs.js "$PROVIDER" > /tmp/docs.json
          echo "Fetched documentation:"
          cat /tmp/docs.json | jq 'to_entries | .[] | {provider: .key, chars: (.value.content | length // 0)}'
      - name: Generate update prompt
        id: prompt
        env:
          DOCS_JSON_FILE: /tmp/docs.json
        run: |
          chmod +x .github/scripts/update-claude-providers.sh
          PROVIDER="${{ github.event.inputs.provider || 'all' }}"
          prompt=$(.github/scripts/update-claude-providers.sh prompt "$PROVIDER")
          {
            echo "prompt<<EOF"
            echo "$prompt"
            echo "EOF"
          } >> $GITHUB_OUTPUT
      - name: Query provider configs with OpenRouter
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_REFERER: https://github.com/${{ github.repository }}
          PROMPT: ${{ steps.prompt.outputs.prompt }}
        run: |
          chmod +x .github/scripts/openrouter-query.sh
          printf '%s' "$PROMPT" | .github/scripts/openrouter-query.sh > /tmp/ai_response.txt
      - name: Apply config updates
        run: |
          cat /tmp/ai_response.txt | .github/scripts/update-claude-providers.sh apply
      - name: Format YAML
        run: |
          npx prettier --write .chezmoidata/claude.yaml
      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain .chezmoidata/claude.yaml)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff .chezmoidata/claude.yaml | head -50 > /tmp/diff.txt
            {
              echo "diff<<EOF"
              cat /tmp/diff.txt
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_PAT }}
          add-paths: .chezmoidata/claude.yaml
          commit-message: "chore(claude): update provider configs"
          title: "chore(claude): update provider configs"
          branch: chore/update-claude-providers
          delete-branch: true
          labels: dependencies,claude,automation
          body: |
            ## Provider Config Update

            Updated Claude Code provider configurations from official documentation.

            ### Provider(s) Updated
            - ${{ github.event.inputs.provider || 'all' }}

            ### Changes
            ```diff
            ${{ steps.changes.outputs.diff }}
            ```

            ### Sources
            - [DeepSeek](https://api-docs.deepseek.com/guides/anthropic_api)
            - [Kimi](https://platform.moonshot.cn/docs/guide/agent-support)
            - [GLM](https://docs.bigmodel.cn/cn/guide/develop/claude)
            - [Qwen](https://help.aliyun.com/zh/model-studio/claude-code)
            - [MiniMax](https://platform.minimax.io/docs/coding-plan/claude-code)
            - [Doubao](https://www.volcengine.com/docs/82379/1928261)

            ---
            *Auto-generated by [update-claude-providers](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
      - name: Summary
        run: |
          echo "## Update Results" >> $GITHUB_STEP_SUMMARY
          echo "- Provider: ${{ github.event.inputs.provider || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changes: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
