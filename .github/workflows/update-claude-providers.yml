name: Update Claude Provider Configs
on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: "0 0 * * 1"
  workflow_dispatch:
    inputs:
      provider:
        description: "Specific provider to update (or 'all')"
        required: false
        default: "all"
permissions:
  contents: write
  pull-requests: write
jobs:
  update-providers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Gemini CLI
        run: npm install -g @anthropic-ai/gemini-cli
      - name: Update provider configs
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Provider documentation URLs
          declare -A PROVIDER_DOCS=(
            ["deepseek"]="https://api-docs.deepseek.com/guides/anthropic_api"
            ["kimi"]="https://platform.moonshot.cn/docs"
            ["glm"]="https://docs.bigmodel.cn/cn/coding-plan/tool/claude"
            ["qwen"]="https://help.aliyun.com/zh/model-studio/claude-code"
            ["minimax"]="https://platform.minimax.io/docs/coding-plan/claude-code"
            ["doubao"]="https://www.volcengine.com/docs/82379/1949118"
          )

          PROVIDER="${{ github.event.inputs.provider || 'all' }}"

          # Create update script
          cat > /tmp/update_providers.py << 'PYTHON'
          import yaml
          import sys
          import json

          def update_provider(yaml_path, provider, config):
              with open(yaml_path, 'r') as f:
                  data = yaml.safe_load(f)

              if provider in data['claude']['providers']:
                  current = data['claude']['providers'][provider]
                  updated = False

                  for key, value in config.items():
                      if key in current and current[key] != value:
                          print(f"  {provider}.{key}: {current[key]} -> {value}")
                          current[key] = value
                          updated = True

                  if updated:
                      with open(yaml_path, 'w') as f:
                          yaml.dump(data, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
                      return True
              return False

          if __name__ == "__main__":
              yaml_path = sys.argv[1]
              provider = sys.argv[2]
              config = json.loads(sys.argv[3])
              if update_provider(yaml_path, provider, config):
                  print(f"Updated {provider}")
              else:
                  print(f"No changes for {provider}")
          PYTHON

          # Function to query Gemini for provider config
          query_provider_config() {
            local provider=$1
            local doc_url=$2

            echo "Querying config for $provider from $doc_url..."

            gemini -p "You are a Claude Code configuration expert.
            Fetch the documentation from $doc_url and extract the Claude Code settings.json configuration.
            Return ONLY a valid JSON object with these fields (omit if not found):
            - base_url: the ANTHROPIC_BASE_URL value
            - model: the ANTHROPIC_MODEL value
            - small_model: the ANTHROPIC_SMALL_FAST_MODEL value
            - timeout_ms: the API_TIMEOUT_MS value (as string)
            - haiku_model: the ANTHROPIC_DEFAULT_HAIKU_MODEL value
            - sonnet_model: the ANTHROPIC_DEFAULT_SONNET_MODEL value
            - opus_model: the ANTHROPIC_DEFAULT_OPUS_MODEL value

            Return ONLY the JSON, no markdown, no explanation." 2>/dev/null || echo "{}"
          }

          # Update providers
          YAML_PATH=".chezmoidata/claude.yaml"
          CHANGES=0

          if [ "$PROVIDER" = "all" ]; then
            for p in "${!PROVIDER_DOCS[@]}"; do
              CONFIG=$(query_provider_config "$p" "${PROVIDER_DOCS[$p]}")
              if [ -n "$CONFIG" ] && [ "$CONFIG" != "{}" ]; then
                python3 /tmp/update_providers.py "$YAML_PATH" "$p" "$CONFIG" && ((CHANGES++)) || true
              fi
              sleep 2  # Rate limiting
            done
          else
            if [ -n "${PROVIDER_DOCS[$PROVIDER]}" ]; then
              CONFIG=$(query_provider_config "$PROVIDER" "${PROVIDER_DOCS[$PROVIDER]}")
              if [ -n "$CONFIG" ] && [ "$CONFIG" != "{}" ]; then
                python3 /tmp/update_providers.py "$YAML_PATH" "$PROVIDER" "$CONFIG" && ((CHANGES++)) || true
              fi
            fi
          fi

          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(claude): update provider configs"
          title: "chore(claude): update provider configs"
          body: |
            Automated update of Claude Code provider configurations.

            This PR was generated by the `update-claude-providers` workflow using Gemini CLI
            to fetch the latest configuration from provider documentation.

            Please review the changes before merging.
          branch: chore/update-claude-providers
          delete-branch: true
          labels: |
            automated
            claude-code
