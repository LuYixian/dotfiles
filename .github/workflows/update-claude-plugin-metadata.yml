name: Update Claude Plugin Metadata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday
permissions:
  contents: write
  pull-requests: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
      - name: Install tools
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Fetch marketplace.json
        run: |
          curl -sL https://raw.githubusercontent.com/wshobson/agents/main/.claude-plugin/marketplace.json \
            > /tmp/marketplace.json
          echo "Fetched $(jq '.plugins | length' /tmp/marketplace.json) plugins from marketplace"
      - name: Scan plugin metadata
        id: scan
        env:
          MARKETPLACE: /tmp/marketplace.json
          OUTPUT: /tmp/plugins.json
        run: |
          chmod +x .github/scripts/update-plugin-metadata.sh
          .github/scripts/update-plugin-metadata.sh scan

          # Generate prompt and check if AI generation is needed
          prompt=$(.github/scripts/update-plugin-metadata.sh prompt)
          if [[ -n "$prompt" ]]; then
            echo "needs_ai=true" >> $GITHUB_OUTPUT
            {
              echo "prompt<<EOF"
              echo "$prompt"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "needs_ai=false" >> $GITHUB_OUTPUT
          fi
      - name: Generate keywords with OpenRouter
        if: steps.scan.outputs.needs_ai == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_REFERER: https://github.com/${{ github.repository }}
          PROMPT: ${{ steps.scan.outputs.prompt }}
        run: |
          chmod +x .github/scripts/openrouter-query.sh
          printf '%s' "$PROMPT" | .github/scripts/openrouter-query.sh > /tmp/ai_response.txt
      - name: Apply AI-generated keywords
        if: steps.scan.outputs.needs_ai == 'true'
        env:
          OUTPUT: /tmp/plugins.json
        run: |
          cat /tmp/ai_response.txt | .github/scripts/update-plugin-metadata.sh apply
      - name: Update claude.yaml
        run: |
          yq -i -P '.claude.wshobsonAgents.registry = load("/tmp/plugins.json")' .chezmoidata/claude.yaml
      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain .chezmoidata/claude.yaml)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_PAT }}
          add-paths: .chezmoidata/claude.yaml
          commit-message: "chore(claude): update plugin metadata"
          title: "chore(claude): update plugin metadata"
          branch: chore/update-claude-plugin-metadata
          delete-branch: true
          labels: dependencies,claude,automation
          body: |
            ## Plugin Metadata Update

            Updated Claude Code plugin registry from upstream marketplace.json.

            ### What's updated
            - Plugin keywords and descriptions in `.chezmoidata/claude.yaml`

            ### Note
            Plugin files are now managed via `.chezmoiexternal.toml` and downloaded
            at `chezmoi apply` time. This workflow only updates metadata.

            ---
            *Auto-generated by [update-claude-plugins](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
      - name: Summary
        run: |
          echo "## Update Results" >> $GITHUB_STEP_SUMMARY
          echo "- Plugins scanned: $(jq length /tmp/plugins.json)" >> $GITHUB_STEP_SUMMARY
          echo "- AI generation needed: ${{ steps.scan.outputs.needs_ai }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changes: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
