# tmux configuration
# Optimized for macOS + Linux with modern plugins
#
# Dependencies:
#   - bash 5.2+ (required by tmux2k, macOS: brew install bash)
#   - fzf / fzf-tmux
#   - sesh (brew install joshmedeski/sesh/sesh)
#   - zoxide, fd (for sesh directory navigation)

# -- terminal & display --------------------------------------------------------

set -g default-terminal "tmux-256color"
# Use set -s (server option) to avoid accumulation on reload
set -s terminal-features ",*256col*:RGB"
# Undercurl support + colors (combined to prevent reload accumulation)
set -g terminal-overrides ',*:Smulx=\E[4::%p1%dm,*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# -- general -------------------------------------------------------------------

# prefix key
set -g prefix C-b
unbind C-a
bind C-b send-prefix

# history & timing
set -g history-limit 50000
set -s escape-time 0
set -g display-time 4000

# status bar length (prevent truncation, but leave room for window list)
set -g status-left-length 80
set -g status-right-length 120

# mouse support
set -g mouse on

# vi mode
set -g status-keys vi
setw -g mode-keys vi

# focus events (for vim/nvim autoread)
set -g focus-events on

# windows & panes
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g automatic-rename on
# show folder name instead of command, so you don't get "zsh zsh"
set -g automatic-rename-format '#{window_icon} #{b:pane_current_path}'

# -- key bindings --------------------------------------------------------------

# reload config
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# new window/pane in current path (tmux-pain-control will add more)
bind c new-window -c "#{pane_current_path}"

# copy mode (vi style) - let tmux-yank handle y/Y/MouseDragEnd1Pane
bind a copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi V send-keys -X select-line
bind -T copy-mode-vi Escape send-keys -X cancel
set -g set-clipboard on

# session management
bind C-n command-prompt -p "New session:" "new-session -s '%%'"
bind C-x confirm-before -p "Kill session #S? (y/n)" kill-session

# ------------------------------------------------------------------------------
# Session Management: sesh (external) + sessionx (internal)
# ------------------------------------------------------------------------------
# sesh  (prefix + T): External entry point - find project/directory ‚Üí create/attach session
#                     Best for: starting work, jumping between projects via zoxide/fd
# sessionx (prefix + O): Internal management panel - preview/rename/delete existing sessions
#                        Best for: managing sessions once inside tmux
# ------------------------------------------------------------------------------

# sesh - external session entry (project-centric workflow)
bind T run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --no-sort --ansi --border-label ' sesh ' --prompt '‚ö° ' \
    --header ' ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö° )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ü™ü )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö° )+reload(sesh list --icons)' \
    --preview-window 'right:50%' \
    --preview 'sesh preview {}'
)\""

# popup windows
bind ` display-popup -E -w 80% -h 80%
bind g display-popup -E -w 90% -h 90% "lazygit"

# toggle synchronize panes (with status display)
bind S if -F '#{synchronize-panes}' \
  'set -w synchronize-panes off \; display "Sync panes: OFF"' \
  'set -w synchronize-panes on \; display "Sync panes: ON"'

# kill pane/window
bind x kill-pane
bind X kill-window

# ==============================================================================
# TPM plugins
# ==============================================================================

# Plugin manager
set -g @plugin 'tmux-plugins/tpm'

# ------------------------------------------------------------------------------
# A) Basic - low conflict, high value
# ------------------------------------------------------------------------------

# Sensible defaults (won't override your settings)
set -g @plugin 'tmux-plugins/tmux-sensible'

# System clipboard integration
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'

# Standard pane key-bindings (vim-style h/j/k/l, resize, split)
# prefix + h/j/k/l - pane navigation
# prefix + H/J/K/L - pane resize
# prefix + | - split horizontal
# prefix + - - split vertical
set -g @plugin 'tmux-plugins/tmux-pain-control'

# ------------------------------------------------------------------------------
# B) Session management (internal) - see also: sesh in key bindings section
# ------------------------------------------------------------------------------

# sessionx - internal session management panel (pairs with sesh above)
set -g @plugin 'omerxx/tmux-sessionx'
set -g @sessionx-bind 'O'
set -g @sessionx-zoxide-mode 'on'
set -g @sessionx-filter-current 'false'
set -g @sessionx-preview-enabled 'true'

# ------------------------------------------------------------------------------
# C) Copy / Jump / Open
# ------------------------------------------------------------------------------

# Extract text from pane with fzf (paths, URLs, hashes, etc.)
# prefix + Tab
set -g @plugin 'laktak/extrakto'
set -g @extrakto_key 'Tab'
set -g @extrakto_split_size '15'
set -g @extrakto_clip_tool_run 'tmux_osc52'

# Easymotion-like jump to any character
# prefix + f
set -g @plugin 'schasse/tmux-jump'
set -g @jump-key 'f'

# Open URLs with fzf selection (junegunn's version, requires tmux 3.3+, fzf 0.53+)
# prefix + u
set -g @plugin 'junegunn/tmux-fzf-url'
set -g @fzf-url-bind 'u'

# Quick open highlighted file/URL in copy-mode
# o - open with default program
# C-o - open with $EDITOR
# S - search with Google
set -g @plugin 'tmux-plugins/tmux-open'

# ------------------------------------------------------------------------------
# D) Status bar / UI
# ------------------------------------------------------------------------------

# tmux2k - status bar with Dracula theme
set -g @plugin '2kabhishek/tmux2k'
set -g @tmux2k-theme 'default'
set -g @tmux2k-show-powerline true
set -g @tmux2k-icons-only false

# Powerline separators
set -g @tmux2k-left-sep ''
set -g @tmux2k-right-sep ''
set -g @tmux2k-window-list-left-sep ''
set -g @tmux2k-window-list-right-sep ''

# Window list settings
set -g @tmux2k-window-list-alignment 'centre'
set -g @tmux2k-window-list-compact true
set -g @tmux2k-window-list-format '#I:#W'
set -g @tmux2k-window-list-flags true

# Dracula + Catppuccin hybrid colors
# Base: Dracula dark | Accents: Catppuccin pastel
set -g @tmux2k-black '#282A36'
set -g @tmux2k-dark-gray '#45475a'
set -g @tmux2k-white '#cdd6f4'
set -g @tmux2k-light-blue '#89dceb'
set -g @tmux2k-blue '#89b4fa'
set -g @tmux2k-light-green '#a6e3a1'
set -g @tmux2k-green '#a6e3a1'
set -g @tmux2k-dark-green '#94e2d5'
set -g @tmux2k-light-orange '#fab387'
set -g @tmux2k-orange '#fab387'
set -g @tmux2k-light-pink '#f5c2e7'
set -g @tmux2k-pink '#f5c2e7'
set -g @tmux2k-light-purple '#cba6f7'
set -g @tmux2k-purple '#cba6f7'
set -g @tmux2k-light-red '#f38ba8'
set -g @tmux2k-red '#f38ba8'
set -g @tmux2k-light-yellow '#f9e2af'
set -g @tmux2k-yellow '#f9e2af'

# UI colors (Dracula base + Catppuccin accents)
set -g @tmux2k-bg-main '#282A36'
set -g @tmux2k-bg-alt '#45475a'
set -g @tmux2k-text '#1e1e2e'
set -g @tmux2k-message-bg '#45475a'
set -g @tmux2k-message-fg '#cdd6f4'
set -g @tmux2k-pane-border '#45475a'
set -g @tmux2k-pane-active-border '#cba6f7'
set -g @tmux2k-prefix-highlight '#f5c2e7'

# Plugin layout
set -g @tmux2k-left-plugins "session git cpu ram"
set -g @tmux2k-right-plugins "battery network time"

# Per-module colors: "bg fg" - Dracula + Catppuccin pastel scheme
# Left side: cool pastels (mauve ‚Üí pink ‚Üí sky ‚Üí green)
set -g @tmux2k-session-colors "purple text"
set -g @tmux2k-git-colors "pink text"
set -g @tmux2k-cpu-colors "light_blue text"
set -g @tmux2k-ram-colors "green text"

# Right side: warm pastels (peach ‚Üí teal ‚Üí yellow)
set -g @tmux2k-battery-colors "orange text"
set -g @tmux2k-network-colors "dark_green text"
set -g @tmux2k-time-colors "yellow text"

# Window list: soft blue accent
set -g @tmux2k-window-list-colors "black blue"

# Nerd Font icons for window names
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

# ------------------------------------------------------------------------------
# E) Mouse / Scroll experience
# ------------------------------------------------------------------------------

# Better mouse mode (smoother scrolling, better selection)
set -g @plugin 'NHDaly/tmux-better-mouse-mode'
set -g @scroll-speed-num-lines-per-scroll '3'

# ------------------------------------------------------------------------------
# F) Session persistence
# ------------------------------------------------------------------------------

# Save/restore sessions across restarts
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Auto-save sessions every 15 minutes
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# ------------------------------------------------------------------------------
# G) Tools
# ------------------------------------------------------------------------------

# Task completion notifications
# prefix + m - monitor pane, notify on finish
# prefix + M - cancel monitoring
set -g @plugin 'rickstaa/tmux-notify'

# Logging and screen capture
# prefix + P - toggle logging
# prefix + Alt + p - save visible pane
# prefix + Alt + P - save complete history
# prefix + Alt + c - clear history
set -g @plugin 'tmux-plugins/tmux-logging'

# Kill hanging processes fast (use with caution!)
# prefix + *
set -g @plugin 'tmux-plugins/tmux-cowboy'

# ==============================================================================
# Initialize TPM
# ==============================================================================

run '~/.tmux/plugins/tpm/tpm'

# ==============================================================================
# Post-TPM overrides (UI elements tmux2k doesn't theme)
# Dracula base (#282A36) + accents
# Reference: catppuccin/tmux, rose-pine/tmux
# ==============================================================================

# -- Dracula color palette -----------------------------------------------------
# Base:    #282a36 (background)
# Current: #44475a (current line / selection)
# Comment: #6272a4 (muted)
# Fg:      #f8f8f2 (foreground)
# Purple:  #bd93f9 (accent)
# Pink:    #ff79c6
# Cyan:    #8be9fd
# Green:   #50fa7b
# Orange:  #ffb86c
# Yellow:  #f1fa8c
# Red:     #ff5555

# -- Pane borders --------------------------------------------------------------
set -g pane-border-style "fg=#6272a4"
set -g pane-active-border-style "fg=#bd93f9"

# -- Display panes (prefix + q) ------------------------------------------------
set -g display-panes-colour "#6272a4"
set -g display-panes-active-colour "#bd93f9"

# -- Messages ------------------------------------------------------------------
set -g message-style "fg=#f8f8f2,bg=#44475a"
set -g message-command-style "fg=#282a36,bg=#ffb86c"

# -- Mode (copy mode / tree mode selection) ------------------------------------
set -g mode-style "fg=#f8f8f2,bg=#44475a,bold"

# -- Clock (prefix + t) --------------------------------------------------------
set -g clock-mode-colour "#bd93f9"

# -- Window status (activity/bell indicators) ---------------------------------
set -g window-status-activity-style "fg=#282a36,bg=#ff79c6"
set -g window-status-bell-style "fg=#282a36,bg=#f1fa8c"

# -- Copy mode cursor ----------------------------------------------------------
set -g copy-mode-match-style "fg=#282a36,bg=#f1fa8c"
set -g copy-mode-current-match-style "fg=#282a36,bg=#ffb86c,bold"
set -g copy-mode-mark-style "fg=#282a36,bg=#ff79c6"

# -- Popup & Menu (tmux 3.4+) --------------------------------------------------
set -g popup-style "fg=#f8f8f2,bg=#282a36"
set -g popup-border-style "fg=#6272a4"
set -g popup-border-lines "rounded"
set -g menu-style "fg=#f8f8f2,bg=#282a36"
set -g menu-selected-style "fg=#f8f8f2,bg=#44475a,bold"
set -g menu-border-style "fg=#6272a4"
set -g menu-border-lines "rounded"
