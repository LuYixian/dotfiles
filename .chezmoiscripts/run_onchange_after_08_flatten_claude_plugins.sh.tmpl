#!/bin/bash
# Flatten Claude Code external plugins (agents, commands, skills)
# Sources: wshobson/agents (plugins) + obra/superpowers (core skills)
# Controlled by .chezmoidata/claude.yaml -> enabledPlugins
# Source repos managed by .chezmoiexternal.toml (refreshPeriod = 168h)
#
# Triggers: wshobsonAgents={{ .versions.wshobsonAgents }} superpowers={{ .versions.superpowers }} enabledPlugins={{ .claude.enabledPlugins | toJson | sha256sum }}

set -euo pipefail

CACHE_DIR="$HOME/.cache/wshobson-agents"
CLAUDE_DIR="$HOME/.claude"
CHEZMOI_SOURCE="${CHEZMOI_SOURCE_DIR:-$HOME/.local/share/chezmoi}"

echo ":: [08] Syncing Claude Code external plugins..."

# Check if cache exists (managed by chezmoi external)
if [[ ! -d "$CACHE_DIR/plugins" ]]; then
	echo "    Cache not found, run 'chezmoi apply -R' to fetch externals"
	exit 0
fi

{{- if and (hasKey .claude "enabledPlugins") (gt (len .claude.enabledPlugins) 0) }}
# Whitelist mode: only enabled plugins
enabled_plugins=(
{{- range .claude.enabledPlugins }}
	"{{ . }}"
{{- end }}
)

# ============================================================================
# Clean orphan directories
# Allowed: local (from chezmoi source) + enabled plugins + superpowers
# ============================================================================
cleanup_orphans() {
	local type=$1 # agents, commands, or skills
	local cleaned=0

	[[ -d "$CLAUDE_DIR/$type" ]] || return 0

	for dir in "$CLAUDE_DIR/$type"/*/; do
		[[ -d "$dir" ]] || continue
		name=$(basename "$dir")

		# Skip if it's a local directory (exists in chezmoi source)
		if [[ -d "$CHEZMOI_SOURCE/dot_claude/$type/$name" ]]; then
			continue
		fi

		# Skip if it's an enabled plugin
		# shellcheck disable=SC2076
		if [[ " ${enabled_plugins[*]} " =~ " ${name} " ]]; then
			continue
		fi

		# Skip superpowers
		if [[ "$name" == "superpowers" ]]; then
			continue
		fi

		# This is an orphan - remove it
		rm -rf "$dir"
		echo "  ðŸ—‘ Orphan removed: $type/$name"
		((cleaned++)) || true
	done

	return $cleaned
}

# Clean orphans for each type
orphan_count=0
for type in agents commands skills; do
	cleanup_orphans "$type" || orphan_count=$((orphan_count + $?))
done
[[ $orphan_count -gt 0 ]] && echo "  Cleaned $orphan_count orphan directories"

plugin_count=0
for plugin_name in "${enabled_plugins[@]}"; do
	plugin_dir="$CACHE_DIR/plugins/$plugin_name"
{{- else }}
# All plugins mode
plugin_count=0
for plugin_dir in "$CACHE_DIR/plugins"/*/; do
	plugin_name=$(basename "$plugin_dir")
{{- end }}

	if [[ ! -d "$plugin_dir" ]]; then
		echo "  âš  Plugin not found: $plugin_name"
		continue
	fi

	# Sync agents (always overwrite for updates)
	if [[ -d "$plugin_dir/agents" ]]; then
		mkdir -p "$CLAUDE_DIR/agents/$plugin_name"
		for f in "$plugin_dir/agents"/*.md; do
			[[ -f "$f" ]] && cp -f "$f" "$CLAUDE_DIR/agents/$plugin_name/"
		done
	fi

	# Sync commands
	if [[ -d "$plugin_dir/commands" ]]; then
		mkdir -p "$CLAUDE_DIR/commands/$plugin_name"
		for f in "$plugin_dir/commands"/*.md; do
			[[ -f "$f" ]] && cp -f "$f" "$CLAUDE_DIR/commands/$plugin_name/"
		done
	fi

	# Sync skills (copy entire directories)
	if [[ -d "$plugin_dir/skills" ]]; then
		mkdir -p "$CLAUDE_DIR/skills/$plugin_name"
		for skill in "$plugin_dir/skills"/*/; do
			[[ -d "$skill" ]] || continue
			skill_name=$(basename "$skill")
			# Remove trailing slash for macOS cp -r compatibility
			skill="${skill%/}"
			# Atomic update: copy to temp, then move (prevents data loss on interrupt)
			cp -r "$skill" "$CLAUDE_DIR/skills/$plugin_name/${skill_name}.new"
			rm -rf "$CLAUDE_DIR/skills/$plugin_name/$skill_name"
			mv "$CLAUDE_DIR/skills/$plugin_name/${skill_name}.new" "$CLAUDE_DIR/skills/$plugin_name/$skill_name"
		done
	fi

	((plugin_count++)) || true
	echo "  âœ“ $plugin_name"
done

echo "âœ… Synced $plugin_count wshobson plugins"

# ============================================================================
# Superpowers sync (obra/superpowers)
# Flat structure: agents/, commands/, skills/ at root level
# ============================================================================
SUPERPOWERS_CACHE="$HOME/.cache/superpowers"

if [[ -d "$SUPERPOWERS_CACHE" ]]; then
	echo ""
	echo ":: Syncing Superpowers..."
	sp_count=0

	# Sync agents
	if [[ -d "$SUPERPOWERS_CACHE/agents" ]]; then
		mkdir -p "$CLAUDE_DIR/agents/superpowers"
		for f in "$SUPERPOWERS_CACHE/agents"/*.md; do
			[[ -f "$f" ]] && cp -f "$f" "$CLAUDE_DIR/agents/superpowers/"
		done
		echo "  âœ“ agents"
		((sp_count++)) || true
	fi

	# Sync commands
	if [[ -d "$SUPERPOWERS_CACHE/commands" ]]; then
		mkdir -p "$CLAUDE_DIR/commands/superpowers"
		for f in "$SUPERPOWERS_CACHE/commands"/*.md; do
			[[ -f "$f" ]] && cp -f "$f" "$CLAUDE_DIR/commands/superpowers/"
		done
		echo "  âœ“ commands"
		((sp_count++)) || true
	fi

	# Sync skills (copy entire directories)
	if [[ -d "$SUPERPOWERS_CACHE/skills" ]]; then
		mkdir -p "$CLAUDE_DIR/skills/superpowers"
		skill_count=0
		for skill in "$SUPERPOWERS_CACHE/skills"/*/; do
			[[ -d "$skill" ]] || continue
			skill_name=$(basename "$skill")
			skill="${skill%/}"
			cp -r "$skill" "$CLAUDE_DIR/skills/superpowers/${skill_name}.new"
			rm -rf "$CLAUDE_DIR/skills/superpowers/$skill_name"
			mv "$CLAUDE_DIR/skills/superpowers/${skill_name}.new" "$CLAUDE_DIR/skills/superpowers/$skill_name"
			((skill_count++)) || true
		done
		echo "  âœ“ skills ($skill_count)"
		((sp_count++)) || true
	fi

	echo "âœ… Superpowers synced"
else
	echo "âš  Superpowers cache not found, run 'chezmoi apply -R' to fetch"
fi
