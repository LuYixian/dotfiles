{{- $suffix := "_arm" -}}
{{- if eq .chezmoi.arch "amd64" -}}{{- $suffix = "" -}}{{- end -}}
#!/bin/bash

set -eufo pipefail

echo ":: [07] Installing Paperlib"

VERSION="{{ .versions.paperlib }}"
REPO="Future-Scholars/paperlib"
DMG_NAME="Paperlib_${VERSION}{{ $suffix }}.dmg"
DMG_URL="https://github.com/${REPO}/releases/download/release-electron-${VERSION}/${DMG_NAME}"
TEMP_DMG="/tmp/${DMG_NAME}"

# Download with explicit error handling
if ! curl -fsSL "$DMG_URL" -o "$TEMP_DMG"; then
    echo "    Failed to download Paperlib v${VERSION}"
    rm -f "$TEMP_DMG"
    exit 1
fi

# Verify download is a valid DMG (not an error page)
if ! file "$TEMP_DMG" | grep -q "zlib compressed"; then
    echo "    Downloaded file is not a valid DMG"
    rm -f "$TEMP_DMG"
    exit 1
fi

VOLUME=$(hdiutil attach "$TEMP_DMG" | grep Volumes | awk '{print $3,$4,$5,$6}' | sed 's/ *$//')
APP_NAME=$(basename "$(find "$VOLUME" -maxdepth 1 -name '*.app' -print -quit)")

echo "    Installing $APP_NAME to /Applications"
cp -R "$VOLUME/$APP_NAME" /Applications/

hdiutil detach "$VOLUME" -quiet
rm "$TEMP_DMG"
