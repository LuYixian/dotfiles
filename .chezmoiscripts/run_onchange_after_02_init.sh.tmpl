#!/bin/bash
# darwin-only: excluded on linux via .chezmoiignore

set -eufo pipefail

# flake.nix: {{ output "sha256sum" (joinPath .chezmoi.homeDir "nix-config/flake.nix") | trim | default "n/a" }}
# flake.lock: {{ output "sha256sum" (joinPath .chezmoi.homeDir "nix-config/flake.lock") | trim | default "n/a" }}
# apps.nix: {{ output "sha256sum" (joinPath .chezmoi.homeDir "nix-config/modules/apps.nix") | trim | default "n/a" }}
# system.nix: {{ output "sha256sum" (joinPath .chezmoi.homeDir "nix-config/modules/system.nix") | trim | default "n/a" }}
# host-users.nix: {{ output "sha256sum" (joinPath .chezmoi.homeDir "nix-config/modules/host-users.nix") | trim | default "n/a" }}

echo ":: [02] Configuring nix-darwin"

# Source nix environment if not already available
if ! command -v nix &>/dev/null; then
    if [[ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    fi
fi

if ! command -v darwin-version >/dev/null 2>&1; then
    echo "    Installing nix-darwin..."
    sudo nix run nix-darwin/master#darwin-rebuild -- switch --flake ~/nix-config#{{ .hostname }} --show-trace --verbose
else
    echo "    Switching nix-darwin configuration..."
    sudo darwin-rebuild switch --flake ~/nix-config#{{ .hostname }} --show-trace --verbose
fi
