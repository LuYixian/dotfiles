repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
        exclude: \.(tmpl|md)$
      - id: end-of-file-fixer
        exclude: \.tmpl$
      - id: check-yaml
        args: [--allow-multiple-documents]
        exclude: \.tmpl$
      - id: check-toml
      - id: check-added-large-files
        args: [--maxkb=500]
      - id: check-merge-conflict
      - id: detect-private-key
  - repo: local
    hooks:
      #####################################
      # Format: non-template files (auto-fix)
      # Requires: treefmt (with shfmt, nixfmt, stylua, prettier)
      #####################################
      - id: treefmt
        name: Format (treefmt)
        language: system
        pass_filenames: false
        files: \.(sh|nix|lua|md|json|yaml|yml)$
        exclude: \.tmpl$
        entry: treefmt
      #####################################
      # Lint: shell scripts (non-template)
      # Requires: shellcheck
      #####################################
      - id: shellcheck
        name: Shellcheck
        language: system
        types: [shell]
        exclude: (\.tmpl$|\.zsh$)
        entry: shellcheck --severity=warning
      #####################################
      # Lint: Lua files (non-template)
      # Requires: selene
      #####################################
      - id: selene
        name: Selene (Lua)
        language: system
        files: \.lua$
        exclude: (\.tmpl$|Spoons/)
        entry: selene
      #####################################
      # Lint: Nix files (non-template)
      # Requires: statix
      #####################################
      - id: statix
        name: Statix (Nix)
        language: system
        pass_filenames: false
        files: \.nix$
        exclude: \.tmpl$
        entry: statix check nix-config/
      #####################################
      # Template: render + format check + lint
      # Requires: chezmoi, treefmt, shellcheck, selene, statix
      #####################################
      - id: check-templates
        name: Validate templates (render + check)
        language: system
        files: \.tmpl$
        exclude: Spoons/
        pass_filenames: false
        entry: |
          bash -c '
            set -e
            tmpdir=$(mktemp -d)
            trap "rm -rf $tmpdir" EXIT

            # Copy required config files (fail if missing)
            for cfg in treefmt.toml stylua.toml selene.toml; do
              if [[ -f "$cfg" ]]; then
                cp "$cfg" "$tmpdir/"
              else
                echo "⚠️  Missing config: $cfg"
              fi
            done

            # Chezmoi config with claude data for template rendering
            cat > "$tmpdir/chezmoi.toml" << EOF
          [data]
          hostname = "test"
          work = false
          private = true
          homeWifiSSIDs = ""
          platform = "darwin"
          installMasApps = true
          timezone = "UTC"
          gitUsername = "test"
          gitEmail = "test@test.com"
          useEncryption = false
          headless = false

          [data.claude.wshobsonAgents]
          include = ["python-development", "javascript-typescript"]

          [[data.claude.wshobsonAgents.registry]]
          name = "python-development"
          description = "Python development"
          keywords = ["python"]

          [[data.claude.wshobsonAgents.registry]]
          name = "javascript-typescript"
          description = "JS/TS development"
          keywords = ["javascript", "typescript"]
          EOF

            # Render templates to tmpdir
            for f in $(find . \( -name "*.sh.tmpl" -o -name "*.lua.tmpl" -o -name "*.json.tmpl" -o -name "*.yaml.tmpl" -o -name "*.yml.tmpl" -o -name "*.md.tmpl" \) ! -path "*/node_modules/*" ! -path "*/Spoons/*"); do
              chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/$(basename "${f%.tmpl}")" 2>/dev/null || true
            done

            # Render nix templates
            mkdir -p "$tmpdir/nix-modules"
            [ -f nix-config/flake.nix.tmpl ] && chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < nix-config/flake.nix.tmpl > "$tmpdir/flake.nix" 2>/dev/null || true
            for f in nix-config/modules/*.tmpl; do
              [ -f "$f" ] && chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/nix-modules/$(basename "${f%.tmpl}")" 2>/dev/null || true
            done

            cd "$tmpdir"

            # Format check
            echo "Checking format with treefmt..."
            if [[ -f treefmt.toml ]]; then
              treefmt --fail-on-change || { echo "❌ Format check failed"; exit 1; }
            fi

            # Lint shell scripts (fail on errors)
            echo "Linting shell scripts..."
            shfiles=$(ls *.sh 2>/dev/null || true)
            if [[ -n "$shfiles" ]]; then
              shellcheck --severity=warning $shfiles
            fi

            # Lint Lua files (warn only - many false positives for hs/vim globals)
            echo "Linting Lua files..."
            luafiles=$(ls *.lua 2>/dev/null || true)
            if [[ -n "$luafiles" ]] && [[ -f selene.toml ]]; then
              selene $luafiles || echo "⚠️  Selene warnings (non-blocking)"
            fi

            # Lint Nix files (warn only)
            echo "Linting Nix files..."
            if [[ -f flake.nix ]]; then
              statix check . || echo "⚠️  Statix warnings (non-blocking)"
            fi

            echo "✅ All template checks passed!"
          '
ci:
  autoupdate_schedule: monthly
