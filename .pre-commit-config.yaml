repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
        exclude: \.tmpl$
      - id: end-of-file-fixer
        exclude: \.tmpl$
      - id: check-yaml
        args: [--allow-multiple-documents]
        exclude: \.tmpl$
      - id: check-toml
      - id: check-added-large-files
        args: [--maxkb=500]
      - id: check-merge-conflict
      - id: detect-private-key
  - repo: local
    hooks:
      #####################################
      # Format: non-template (auto-fix)
      #####################################
      - id: fmt
        name: Format
        language: system
        pass_filenames: false
        files: \.(sh|nix|lua|md|json|yaml|yml)$
        exclude: \.tmpl$
        entry: |
          bash -c '
            set -e
            # Shell
            find . -name "*.sh" ! -path "*/node_modules/*" -exec nix run nixpkgs#shfmt -- -w {} + 2>/dev/null || true
            # Nix
            find nix-config -name "*.nix" -exec nix run nixpkgs#nixfmt-rfc-style -- {} + 2>/dev/null || true
            # Lua
            find . -name "*.lua" ! -path "*/node_modules/*" ! -path "*/Spoons/*" -exec nix run nixpkgs#stylua -- {} + 2>/dev/null || true
            # MD/JSON/YAML
            find . \( -name "*.md" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" \) ! -name "*.tmpl" ! -path "*/node_modules/*" -exec nix run nixpkgs#nodePackages.prettier -- --write {} + 2>/dev/null || true
          '
      #####################################
      # Format: template (check only)
      #####################################
      - id: fmt-check-tmpl
        name: Format check templates
        language: system
        files: \.tmpl$
        exclude: Spoons/
        pass_filenames: false
        entry: |
          bash -c '
            set -e
            tmpdir=$(mktemp -d); trap "rm -rf $tmpdir" EXIT
            mkdir -p "$tmpdir/modules"
            printf "[data]\nhostname = \"test\"\nwork = false\nprivate = true\nhomeWifiSSIDs = \"\"\nplatform = \"darwin\"\ninstallMasApps = true\ntimezone = \"UTC\"\ngitUsername = \"test\"\ngitEmail = \"test@test.com\"\n" > "$tmpdir/chezmoi.toml"
            cp stylua.toml "$tmpdir/" 2>/dev/null || true

            # Render all templates
            for f in $(find . \( -name "*.sh.tmpl" -o -name "*.lua.tmpl" -o -name "*.json.tmpl" -o -name "*.yaml.tmpl" -o -name "*.yml.tmpl" \) ! -path "*/node_modules/*" ! -path "*/Spoons/*"); do
              chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/$(basename "${f%.tmpl}")"
            done
            [ -f nix-config/flake.nix.tmpl ] && chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < nix-config/flake.nix.tmpl > "$tmpdir/flake.nix"
            for f in nix-config/modules/*.tmpl; do
              [ -f "$f" ] && chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/modules/$(basename "${f%.tmpl}")"
            done

            cd "$tmpdir"
            # Check format (diff mode)
            [ -n "$(ls *.sh 2>/dev/null)" ] && nix run nixpkgs#shfmt -- -d *.sh
            [ -n "$(ls *.lua 2>/dev/null)" ] && nix run nixpkgs#stylua -- --check *.lua
            [ -f flake.nix ] && nix run nixpkgs#nixfmt-rfc-style -- --check flake.nix modules/*.nix
            files=$(ls *.json *.yaml *.yml 2>/dev/null || true)
            [ -n "$files" ] && nix run nixpkgs#nodePackages.prettier -- --check $files
          '
      #####################################
      # Lint: all files
      #####################################
      - id: lint
        name: Lint
        language: system
        files: \.(sh|lua|nix)
        pass_filenames: false
        entry: |
          bash -c '
            set -e
            tmpdir=$(mktemp -d); trap "rm -rf $tmpdir" EXIT
            printf "[data]\nhostname = \"test\"\nwork = false\nprivate = true\nhomeWifiSSIDs = \"\"\nplatform = \"darwin\"\ninstallMasApps = true\ntimezone = \"UTC\"\ngitUsername = \"test\"\ngitEmail = \"test@test.com\"\n" > "$tmpdir/chezmoi.toml"
            cp selene.toml "$tmpdir/" 2>/dev/null || true

            # Render templates to tmpdir
            for f in $(find . -name "*.sh.tmpl" ! -path "*/node_modules/*"); do
              chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/$(basename "${f%.tmpl}")"
            done
            for f in $(find . -name "*.lua.tmpl" ! -path "*/node_modules/*" ! -path "*/Spoons/*"); do
              chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/$(basename "${f%.tmpl}")"
            done
            mkdir -p "$tmpdir/nix-modules"
            chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < nix-config/flake.nix.tmpl > "$tmpdir/flake.nix" 2>/dev/null || true
            for f in nix-config/modules/*.tmpl; do
              [ -f "$f" ] && chezmoi execute-template --config "$tmpdir/chezmoi.toml" --source . < "$f" > "$tmpdir/nix-modules/$(basename "${f%.tmpl}")"
            done

            # Lint non-template files
            find . -name "*.sh" ! -name "*.tmpl" ! -path "*/node_modules/*" -exec nix run nixpkgs#shellcheck -- --severity=warning {} + || true
            find . -name "*.lua" ! -name "*.tmpl" ! -path "*/node_modules/*" ! -path "*/Spoons/*" -exec nix run nixpkgs#selene -- {} + || true
            nix run nixpkgs#statix -- check nix-config/ 2>/dev/null || true

            # Lint rendered templates
            [ -n "$(ls $tmpdir/*.sh 2>/dev/null)" ] && nix run nixpkgs#shellcheck -- --severity=warning $tmpdir/*.sh
            [ -n "$(ls $tmpdir/*.lua 2>/dev/null)" ] && (cd $tmpdir && nix run nixpkgs#selene -- *.lua)
            [ -f "$tmpdir/flake.nix" ] && nix run nixpkgs#statix -- check "$tmpdir"
          '
ci:
  autoupdate_schedule: monthly
