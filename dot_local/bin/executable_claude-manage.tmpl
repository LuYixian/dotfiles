#!/bin/bash
# Claude Code Provider Manager
# Manage default provider and API keys with fzf interface
#
# Usage:
#   claude-manage                  # fzf interactive manager
#   claude-manage provider         # List all providers
#   claude-manage accounts [p]     # List accounts for provider
#   claude-manage default [p@a]    # Get/set default provider
#   claude-manage add [p@a]        # Add new account (must not exist)
#   claude-manage update [p@a]     # Update existing account API key
#   claude-manage test [p@a]       # Test connectivity
#   claude-manage delete [p@a]     # Delete account

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Paths
CHEZMOI_CONFIG="${HOME}/.config/chezmoi/chezmoi.toml"
SETTINGS_FILE="${HOME}/.claude/settings.json"

# Available providers (from chezmoi data)
PROVIDERS=({{- range $name, $_ := .claude.providers }} "{{ $name }}"{{- end }})

# Parse provider@account format
parse_provider_account() {
    local input="$1"
    # Strip status markers from fzf output
    input=$(echo "$input" | sed 's/ ✓$//' | sed 's/^[[:space:]]*//')
    if [[ "$input" =~ ^([^@]+)@(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    elif [[ "$input" =~ ^([^/]+)/(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    else
        echo "$input|default"
    fi
}

require_cmd() {
    local c
    for c in "$@"; do
        if ! command -v "$c" &>/dev/null; then
            echo -e "${RED}Error:${NC} required command not found: $c" >&2
            return 1
        fi
    done
}

validate_account() {
    local account="$1"
    [[ -n "$account" ]] || return 1
    [[ ! "$account" =~ [/@[:space:]] ]] || return 1
    [[ "$account" =~ ^[A-Za-z0-9._-]+$ ]] || return 1
}

# Check if provider is valid
is_valid_provider() {
    local provider="$1"
    for p in "${PROVIDERS[@]}"; do
        [[ "$p" == "$provider" ]] && return 0
    done
    return 1
}

# Check if provider is third-party
is_third_party() {
    local provider="$1"
    case "$provider" in
{{- range $name, $config := .claude.providers }}
{{- if $config.base_url }}
        {{ $name }}) return 0 ;;
{{- end }}
{{- end }}
        *) return 1 ;;
    esac
}

# Get current provider@account from chezmoi
get_current() {
    chezmoi data --format json 2>/dev/null | jq -r '.claudeProviderAccount // .claudeProvider // "anthropic"'
}

# Set provider in chezmoi.toml
set_provider() {
    local provider_account="$1"
    local tmp_file
    tmp_file=$(mktemp)
    # Cleanup on exit/error
    trap "rm -f '$tmp_file'" EXIT

    if grep -q "^claudeProviderAccount = " "$CHEZMOI_CONFIG"; then
        sed "s/^claudeProviderAccount = .*/claudeProviderAccount = \"$provider_account\"/" "$CHEZMOI_CONFIG" > "$tmp_file"
    elif grep -q "^claudeProvider = " "$CHEZMOI_CONFIG"; then
        sed "s/^claudeProvider = .*/claudeProviderAccount = \"$provider_account\"/" "$CHEZMOI_CONFIG" > "$tmp_file"
    else
        cp "$CHEZMOI_CONFIG" "$tmp_file"
        echo "claudeProviderAccount = \"$provider_account\"" >> "$tmp_file"
    fi
    mv "$tmp_file" "$CHEZMOI_CONFIG"
    trap - EXIT  # Clear trap after successful move
}

# List accounts for a provider from gopass
list_accounts() {
    local provider="$1"
    local prefix="claude-code/providers/$provider"
    gopass list -f "$prefix" 2>/dev/null \
        | grep -E '/api_key$' \
        | sed 's|.*/\([^/]*\)/api_key$|\1|' \
        | sort -u
}

# Build provider list with accounts
build_provider_list() {
    for provider in "${PROVIDERS[@]}"; do
        local accounts
        accounts=$(list_accounts "$provider" 2>/dev/null) || true

        if [[ -z "$accounts" ]]; then
            echo "$provider"
        else
            while IFS= read -r account; do
                if [[ "$account" == "default" ]]; then
                    echo "$provider"
                else
                    echo "$provider@$account"
                fi
            done <<< "$accounts"
        fi
    done
}

# Build list with current status indicator
build_provider_list_with_status() {
    local current
    current=$(get_current)
    local current_clean
    current_clean=$(echo "$current" | sed 's/@default$//')

    build_provider_list | while read -r item; do
        local item_clean
        item_clean=$(echo "$item" | sed 's/@default$//')

        if [[ "$item_clean" == "$current_clean" ]]; then
            echo -e "${GREEN}$item ✓${NC}"
        else
            echo "  $item"
        fi
    done
}

# FZF interactive manager
fzf_manage() {
    local current
    current=$(get_current)

    local selected
    selected=$({
        echo -e "${GREEN}+ Add new account...${NC}"
        echo -e "${YELLOW}+ Update API key...${NC}"
        build_provider_list_with_status
    } | fzf --ansi \
        --height=50% \
        --border=rounded \
        --header="Provider Manager (Current: $current)" \
        --preview='
            input=$(echo {} | sed "s/ ✓$//" | sed "s/^[[:space:]]*//" | sed "s/^+ .*//" )
            if [[ -z "$input" ]]; then
                exit 0
            fi
            if echo {} | grep -q "Add new"; then
                echo -e "\033[1;32mAdd new account\033[0m"
                echo ""
                echo "Create a new provider account."
                echo "Account must not already exist."
                exit 0
            fi
            if echo {} | grep -q "Update API"; then
                echo -e "\033[1;33mUpdate API key\033[0m"
                echo ""
                echo "Update API key for existing account."
                echo "Select from configured accounts."
                exit 0
            fi
            provider=$(echo "$input" | cut -d@ -f1)
            account=$(echo "$input" | grep -o "@.*" | cut -c2-)
            account=${account:-default}

            echo -e "\033[1;34mProvider:\033[0m $provider"
            echo -e "\033[1;34mAccount:\033[0m $account"
            echo ""

            # Show config
            claude-token --config "$provider" 2>/dev/null | jq -r "
                \"Model: \(.model // \"N/A\")\",
                \"Base URL: \(.base_url // \"Native Anthropic (OAuth)\")\"
            " 2>/dev/null || echo "Config not available"
            echo ""

            # Check token status
            if claude-token --check "$input" 2>/dev/null; then
                echo -e "\033[0;32m✓ Token configured\033[0m"
            else
                base_url=$(claude-token --config "$provider" 2>/dev/null | jq -r ".base_url // empty")
                if [[ -n "$base_url" ]]; then
                    echo -e "\033[0;31m✗ No token configured\033[0m"
                else
                    echo -e "\033[0;33m○ Native OAuth (no token needed)\033[0m"
                fi
            fi

            # Show if current
            current_provider="'"$current"'"
            current_clean=$(echo "$current_provider" | sed "s/@default$//")
            input_clean=$(echo "$input" | sed "s/@default$//")
            if [[ "$input_clean" == "$current_clean" ]]; then
                echo -e "\n\033[0;32m● This is the current default\033[0m"
            fi
        ' \
        --preview-window='right:45%:wrap') || true

    [[ -z "$selected" ]] && return 0

    # Handle special entries
    if [[ "$selected" == *"Add new"* ]]; then
        cmd_add
    elif [[ "$selected" == *"Update API"* ]]; then
        cmd_update
    else
        # Clean up selection and set as default
        selected=$(echo "$selected" | sed 's/ ✓$//' | sed 's/^[[:space:]]*//')
        cmd_default "$selected"
    fi
}

# List providers command
cmd_provider() {
    local current
    current=$(get_current)
    local current_provider current_account
    local parsed
    parsed=$(parse_provider_account "$current")
    current_provider=$(echo "$parsed" | cut -d'|' -f1)
    current_account=$(echo "$parsed" | cut -d'|' -f2)

    echo -e "${BLUE}Available providers:${NC}"
    echo ""

{{- range $name, $config := .claude.providers }}
    if [[ "{{ $name }}" == "$current_provider" ]]; then
        if [[ "$current_account" == "default" ]]; then
            echo -e "  ${GREEN}✓ {{ $name }}${NC} - {{ index $config "model" }}"
        else
            echo -e "  ${GREEN}✓ {{ $name }}@${current_account}${NC} - {{ index $config "model" }}"
        fi
    else
        echo -e "    {{ $name }} - {{ index $config "model" }}"
    fi
{{- end }}

    echo ""
    if [[ "$current_account" == "default" ]]; then
        echo -e "Current: ${GREEN}$current_provider${NC}"
    else
        echo -e "Current: ${GREEN}$current_provider@$current_account${NC}"
    fi
}

# Default command (get/set)
cmd_default() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        # Get current
        local current
        current=$(get_current)
        echo -e "Current default: ${GREEN}$current${NC}"
        return 0
    fi

    # Parse and validate
    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        echo ""
        cmd_list
        return 1
    fi

    # For third-party, verify token exists
    if is_third_party "$provider"; then
        local display_name
        if [[ "$account" == "default" ]]; then
            display_name="$provider"
        else
            display_name="$provider@$account"
        fi

        if ! claude-token --check "$display_name" 2>/dev/null; then
            echo -e "${RED}Error: No API token for $display_name${NC}" >&2
            echo -e "Run: ${YELLOW}claude-manage add-key $display_name${NC}" >&2
            return 1
        fi
    fi

    local target
    if [[ "$account" == "default" ]]; then
        target="$provider"
    else
        target="$provider@$account"
    fi

    local current
    current=$(get_current)
    if [[ "$current" == "$target" ]]; then
        echo -e "${YELLOW}Already using '$target'${NC}"
        return 0
    fi

    echo -e "${BLUE}Setting default to $target...${NC}"

    # Update chezmoi.toml
    set_provider "$target"
    echo "  ✓ Updated chezmoi.toml"

    # Apply chezmoi
    chezmoi apply "$SETTINGS_FILE"
    echo "  ✓ Applied chezmoi"

    echo ""
    echo -e "${GREEN}✓ Default set to $target${NC}"
    echo -e "${YELLOW}Restart Claude Code to apply changes${NC}"
}

# Check if account exists in gopass
account_exists() {
    local provider="$1"
    local account="$2"
    gopass list -f "claude-code/providers/$provider/$account/api_key" &>/dev/null
}

# Add new account command (must not exist)
cmd_add() {
    local input="${1:-}"
    local provider account

    if [[ -z "$input" ]]; then
        # Select provider first
        provider=$(printf '%s\n' "${PROVIDERS[@]}" | fzf \
            --height=40% \
            --border=rounded \
            --header='Select provider for new account') || true
        [[ -z "$provider" ]] && return 0

        if ! is_third_party "$provider"; then
            echo -e "${YELLOW}Provider '$provider' uses native OAuth, no accounts needed${NC}"
            return 0
        fi

        # Get account name
        printf "Account name (e.g., work, personal, default): "
        read -r account
    else
        # Parse provider@account
        local parsed
        parsed=$(parse_provider_account "$input")
        provider=$(echo "$parsed" | cut -d'|' -f1)
        account=$(echo "$parsed" | cut -d'|' -f2)
    fi

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        return 1
    fi

    if ! is_third_party "$provider"; then
        echo -e "${YELLOW}Provider '$provider' uses native OAuth, no accounts needed${NC}"
        return 0
    fi

    if ! validate_account "$account"; then
        echo -e "${RED}Error: Invalid account name '$account' (use letters/numbers/._- only)${NC}" >&2
        return 1
    fi

    # Check account doesn't already exist
    if account_exists "$provider" "$account"; then
        local display_name
        if [[ "$account" == "default" ]]; then
            display_name="$provider"
        else
            display_name="$provider@$account"
        fi
        echo -e "${RED}Error: Account '$display_name' already exists${NC}" >&2
        echo -e "Use ${YELLOW}claude-manage update $display_name${NC} to update the API key" >&2
        return 1
    fi

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    echo -e "${BLUE}Adding new account $display_name${NC}"
    printf "API Key: "
    read -rs api_key
    echo ""

    if [[ -z "$api_key" ]]; then
        echo -e "${RED}Error: API key required${NC}" >&2
        return 1
    fi

    # Store in gopass
    echo "$api_key" | gopass insert -f "claude-code/providers/$provider/$account/api_key"
    echo -e "${GREEN}✓ Account created and API key saved${NC}"

    # Offer to test
    printf "Test connectivity? [Y/n]: "
    read -r test_choice
    if [[ "$test_choice" != "n" && "$test_choice" != "N" ]]; then
        cmd_test "$display_name"
    fi
}

# Build list of existing accounts only
build_existing_accounts() {
    for provider in "${PROVIDERS[@]}"; do
        if ! is_third_party "$provider"; then
            continue
        fi
        local accounts
        accounts=$(list_accounts "$provider" 2>/dev/null) || true
        if [[ -n "$accounts" ]]; then
            while IFS= read -r account; do
                if [[ "$account" == "default" ]]; then
                    echo "$provider"
                else
                    echo "$provider@$account"
                fi
            done <<< "$accounts"
        fi
    done
}

# Update existing account command (must exist)
cmd_update() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        # Show only existing accounts
        local existing
        existing=$(build_existing_accounts)
        if [[ -z "$existing" ]]; then
            echo -e "${YELLOW}No existing accounts to update${NC}"
            echo -e "Use ${GREEN}claude-manage add${NC} to create a new account"
            return 0
        fi

        input=$(echo "$existing" | fzf \
            --height=40% \
            --border=rounded \
            --header='Select account to update API key' \
            --preview='echo "Will update API key for: {}"') || true
        [[ -z "$input" ]] && return 0
    fi

    # Parse
    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        return 1
    fi

    if ! is_third_party "$provider"; then
        echo -e "${YELLOW}Provider '$provider' uses native OAuth, no API key needed${NC}"
        return 0
    fi

    # Check account exists
    if ! account_exists "$provider" "$account"; then
        local display_name
        if [[ "$account" == "default" ]]; then
            display_name="$provider"
        else
            display_name="$provider@$account"
        fi
        echo -e "${RED}Error: Account '$display_name' does not exist${NC}" >&2
        echo -e "Use ${GREEN}claude-manage add $display_name${NC} to create it first" >&2
        return 1
    fi

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    echo -e "${BLUE}Updating API key for $display_name${NC}"
    printf "New API Key: "
    read -rs api_key
    echo ""

    if [[ -z "$api_key" ]]; then
        echo -e "${RED}Error: API key required${NC}" >&2
        return 1
    fi

    # Store in gopass (overwrite)
    echo "$api_key" | gopass insert -f "claude-code/providers/$provider/$account/api_key"
    echo -e "${GREEN}✓ API key updated${NC}"

    # Offer to test
    printf "Test connectivity? [Y/n]: "
    read -r test_choice
    if [[ "$test_choice" != "n" && "$test_choice" != "N" ]]; then
        cmd_test "$display_name"
    fi
}

# Test command
cmd_test() {
    local input="${1:-}"

    # If no input, use fzf or current
    if [[ -z "$input" ]]; then
        input=$(get_current)
    fi

    # Parse
    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        return 1
    fi

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    # Get base_url
    local base_url
    base_url=$(claude-token --config "$provider" | jq -r '.base_url // empty')

    if [[ -z "$base_url" ]]; then
        echo -e "${YELLOW}Provider '$provider' is native Anthropic (uses OAuth)${NC}"
        echo -e "${GREEN}✓ No API key needed${NC}"
        return 0
    fi

    require_cmd curl || return 1

    echo -e "${BLUE}Testing $display_name...${NC}"
    echo "  Base URL: $base_url"

    # Check token
    if ! claude-token --check "$display_name" 2>/dev/null; then
        echo -e "  ${RED}✗ No API token configured${NC}"
        echo -e "Run: ${YELLOW}claude-manage add-key $display_name${NC}"
        return 1
    fi
    echo -e "  ${GREEN}✓ Token found${NC}"

    # Get token and test
    local token
    if ! token=$(claude-token "$display_name" 2>/dev/null); then
        echo -e "  ${RED}✗ Failed to decrypt token${NC}" >&2
        return 1
    fi

    echo "  Testing API..."

    local model
    model=$(claude-token --config "$provider" | jq -r '.model // "unknown"')

    local response http_code
    response=$(curl -sS -w "\n%{http_code}" --max-time 30 \
        -X POST "$base_url/v1/messages" \
        -H "x-api-key: $token" \
        -H "anthropic-version: 2023-06-01" \
        -H "Content-Type: application/json" \
        -d "{\"model\":\"$model\",\"max_tokens\":1,\"messages\":[{\"role\":\"user\",\"content\":\"hi\"}]}" 2>&1)

    http_code=$(echo "$response" | tail -n1)

    case "$http_code" in
        200)
            echo -e "  ${GREEN}✓ API connection successful${NC}"
            ;;
        401)
            echo -e "  ${RED}✗ Authentication failed (invalid API key)${NC}"
            return 1
            ;;
        403)
            echo -e "  ${RED}✗ Access forbidden${NC}"
            return 1
            ;;
        429)
            echo -e "  ${YELLOW}⚠ Rate limited but reachable${NC}"
            ;;
        *)
            echo -e "  ${YELLOW}⚠ HTTP $http_code${NC}"
            ;;
    esac

    echo ""
    echo -e "${GREEN}✓ Provider $display_name is working${NC}"
}

# Accounts command
cmd_accounts() {
    local provider="${1:-}"

    if [[ -z "$provider" ]]; then
        # List all accounts for all providers
        for p in "${PROVIDERS[@]}"; do
            local accounts
            accounts=$(list_accounts "$p" 2>/dev/null) || true
            if [[ -n "$accounts" ]]; then
                echo -e "${BLUE}$p:${NC}"
                echo "$accounts" | sed 's/^/  /'
            fi
        done
    else
        if ! is_valid_provider "$provider"; then
            echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
            return 1
        fi

        local accounts
        accounts=$(list_accounts "$provider" 2>/dev/null) || true
        if [[ -n "$accounts" ]]; then
            echo -e "${BLUE}Accounts for $provider:${NC}"
            echo "$accounts" | sed 's/^/  /'
        else
            echo -e "${YELLOW}No accounts configured for $provider${NC}"
        fi
    fi
}

# Delete account command
cmd_delete() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        # Show only existing accounts
        local existing
        existing=$(build_existing_accounts)
        if [[ -z "$existing" ]]; then
            echo -e "${YELLOW}No accounts to delete${NC}"
            return 0
        fi

        input=$(echo "$existing" | fzf \
            --height=40% \
            --border=rounded \
            --header='Select account to delete' \
            --preview='echo "Will delete: {}"') || true
        [[ -z "$input" ]] && return 0
    fi

    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    if ! account_exists "$provider" "$account"; then
        echo -e "${RED}Error: Account does not exist${NC}" >&2
        return 1
    fi

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    echo -e "${YELLOW}Delete account $display_name?${NC}"
    printf "This will remove the API key from gopass. Continue? [y/N]: "
    read -r confirm

    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        gopass rm -f "claude-code/providers/$provider/$account/api_key" 2>/dev/null || true
        echo -e "${GREEN}✓ Account deleted${NC}"
    else
        echo "Cancelled"
    fi
}

# Show help
show_help() {
    cat << 'EOF'
Claude Code Provider Manager

Usage:
  claude-manage                  Interactive fzf picker
  claude-manage provider         List all providers
  claude-manage accounts [p]     List accounts for provider
  claude-manage default [p@a]    Get/set default provider
  claude-manage add [p@a]        Add new account (must not exist)
  claude-manage update [p@a]     Update existing account API key
  claude-manage delete [p@a]     Delete account
  claude-manage test [p@a]       Test connectivity

Examples:
  claude-manage                    # Open fzf picker
  claude-manage provider           # List all providers
  claude-manage add kimi@work      # Add new Kimi work account
  claude-manage update kimi@work   # Update API key
  claude-manage default deepseek   # Set DeepSeek as default
EOF
}

# Main
main() {
    local cmd="${1:-}"
    shift || true

    require_cmd chezmoi jq fzf gopass || exit 1

    case "$cmd" in
        ""|interactive)
            fzf_manage
            ;;
        provider|providers|list|ls)
            cmd_provider
            ;;
        default)
            cmd_default "$@"
            ;;
        add|new)
            cmd_add "$@"
            ;;
        update|set)
            cmd_update "$@"
            ;;
        delete|rm|remove)
            cmd_delete "$@"
            ;;
        test)
            cmd_test "$@"
            ;;
        accounts)
            cmd_accounts "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            # Check if it looks like a provider
            local parsed_provider
            parsed_provider=$(parse_provider_account "$cmd" | cut -d'|' -f1)
            if is_valid_provider "$parsed_provider"; then
                cmd_default "$cmd"
            else
                echo -e "${RED}Unknown command: $cmd${NC}" >&2
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"
