#!/bin/bash
# Claude Code Provider Switcher (Declarative)
# Modifies chezmoi state (claudeProvider) and applies changes
set -eo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Paths
CHEZMOI_CONFIG="${HOME}/.config/chezmoi/chezmoi.toml"
SETTINGS_FILE="${HOME}/.claude/settings.json"

# Available providers (from .chezmoidata/claude.yaml)
PROVIDERS=({{- range $name, $_ := .claude.providers }} "{{ $name }}"{{- end }})

# Get current provider from chezmoi data
get_current() {
    chezmoi data --format json 2>/dev/null | jq -r '.claudeProvider // "anthropic"'
}

# Set provider in chezmoi.toml (portable across macOS and Linux)
set_provider() {
    local provider="$1"
    local tmp_file
    tmp_file=$(mktemp)
    sed "s/^claudeProvider = .*/claudeProvider = \"$provider\"/" "$CHEZMOI_CONFIG" > "$tmp_file" && mv "$tmp_file" "$CHEZMOI_CONFIG"
}

# Check if provider is valid
is_valid_provider() {
    local provider="$1"
    for p in "${PROVIDERS[@]}"; do
        [[ "$p" == "$provider" ]] && return 0
    done
    return 1
}

# Check if provider is third-party (has base_url)
is_third_party() {
    local provider="$1"
    case "$provider" in
{{- range $name, $config := .claude.providers }}
{{- if $config.base_url }}
        {{ $name }}) return 0 ;;
{{- end }}
{{- end }}
        *) return 1 ;;
    esac
}

# List available providers
list_providers() {
    local current
    current=$(get_current)

    echo -e "${BLUE}Available providers:${NC}"
    echo ""
{{- range $name, $config := .claude.providers }}
    if [[ "{{ $name }}" == "$current" ]]; then
        echo -e "  ${GREEN}✓ {{ $name }}${NC} - {{ $config.model }}"
    else
        echo -e "    {{ $name }} - {{ $config.model }}"
    fi
{{- end }}
    echo ""
    echo -e "Current: ${GREEN}$current${NC}"
}

# Show current provider details
show_current() {
    local current
    current=$(get_current)

    echo -e "${BLUE}Current provider:${NC} ${GREEN}$current${NC}"
    echo ""

    # Show current settings from settings.json
    if [[ -f "$SETTINGS_FILE" ]]; then
        echo "Settings:"
        jq -r '.env | to_entries | .[] | select(.key | startswith("ANTHROPIC") or startswith("_CLAUDE")) | "  \(.key)=\(.value)"' "$SETTINGS_FILE" 2>/dev/null
    fi
}

# Switch to a provider
switch_provider() {
    local provider="${1:-}"

    if [[ -z "$provider" ]]; then
        echo -e "${RED}Error: Provider name required${NC}" >&2
        echo "Usage: claude-switch use <provider>" >&2
        echo ""
        list_providers
        return 1
    fi

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        echo ""
        list_providers
        return 1
    fi

    local current
    current=$(get_current)

    if [[ "$current" == "$provider" ]]; then
        echo -e "${YELLOW}Already using '$provider'${NC}"
        return 0
    fi

    # Third-party providers require API token
    if is_third_party "$provider"; then
        if ! gopass show -o "claude-code/providers/$provider/api_key" &>/dev/null; then
            echo -e "${RED}Error: API token not found for '$provider'${NC}" >&2
            echo -e "Run: ${YELLOW}claude-switch add-key $provider${NC}" >&2
            return 1
        fi
    fi

    echo -e "${BLUE}Switching to $provider...${NC}"

    # 1. Update chezmoi.toml
    set_provider "$provider"
    echo "  ✓ Updated chezmoi.toml"

    # 2. Apply chezmoi to regenerate settings.json
    chezmoi apply "$SETTINGS_FILE"
    echo "  ✓ Applied chezmoi"

    echo ""
    echo -e "${GREEN}✓ Switched to $provider${NC}"
    echo -e "${YELLOW}Restart Claude Code to apply changes${NC}"
}

# Add API key for a provider
add_key() {
    local provider="${1:-}"

    if [[ -z "$provider" ]]; then
        echo -e "${RED}Error: Provider name required${NC}" >&2
        echo "Usage: claude-switch add-key <provider>" >&2
        return 1
    fi

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        list_providers
        return 1
    fi

    if ! command -v gopass &>/dev/null; then
        echo -e "${RED}Error: gopass not found${NC}" >&2
        return 1
    fi

    echo -e "${BLUE}Adding API key for $provider${NC}"
    echo -n "API Key: "
    read -rs api_key
    echo ""

    if [[ -z "$api_key" ]]; then
        echo -e "${RED}Error: API key required${NC}" >&2
        return 1
    fi

    echo "$api_key" | gopass insert -f "claude-code/providers/$provider/api_key"
    echo -e "${GREEN}✓ API key saved to gopass${NC}"
}

# Show help
show_help() {
    cat << 'EOF'
Claude Code Provider Switcher

Usage: claude-switch <command> [args]

Commands:
  list              List available providers
  current           Show current provider details
  use <provider>    Switch to a provider
  add-key <provider> Add/update API key in gopass
  help              Show this help

Examples:
  claude-switch list              # List all providers
  claude-switch use deepseek      # Switch to DeepSeek
  claude-switch add-key deepseek  # Add DeepSeek API key

How it works:
  1. Modifies claudeProvider in ~/.config/chezmoi/chezmoi.toml
  2. Runs chezmoi apply to regenerate ~/.claude/settings.json
  3. Restart Claude Code to apply changes

Providers:
EOF
{{- range $name, $config := .claude.providers }}
  echo "  {{ $name }} - {{ $config.model }}"
{{- end }}
}

# Main
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        list|ls)
            list_providers
            ;;
        current|status)
            show_current
            ;;
        use|switch)
            switch_provider "$@"
            ;;
        add-key|add)
            add_key "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            # If argument looks like a provider name, switch to it
            if is_valid_provider "$cmd"; then
                switch_provider "$cmd"
            else
                echo -e "${RED}Unknown command: $cmd${NC}" >&2
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"
