#!/bin/bash
# Claude Code Provider Switcher (Declarative)
# Modifies chezmoi state (claudeProvider) and applies changes
set -eo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Paths
CHEZMOI_CONFIG="${HOME}/.config/chezmoi/chezmoi.toml"
SETTINGS_FILE="${HOME}/.claude/settings.json"

# Available providers (from .chezmoidata/claude.yaml)
PROVIDERS=({{- range $name, $_ := .claude.providers }} "{{ $name }}"{{- end }})

# Parse provider@account format
# Returns: provider|account
parse_provider_account() {
    local input="$1"
    if [[ "$input" =~ ^([^@]+)@(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    else
        echo "$input|default"
    fi
}

# Get current provider@account from chezmoi data
get_current() {
    chezmoi data --format json 2>/dev/null | jq -r '.claudeProviderAccount // .claudeProvider // "anthropic"'
}

# Get current provider (without account)
get_current_provider() {
    local current
    current=$(get_current)
    parse_provider_account "$current" | cut -d'|' -f1
}

# Get current account
get_current_account() {
    local current
    current=$(get_current)
    parse_provider_account "$current" | cut -d'|' -f2
}

# Set provider@account in chezmoi.toml (portable across macOS and Linux)
set_provider() {
    local provider_account="$1"
    local tmp_file
    tmp_file=$(mktemp)

    # Handle both old (claudeProvider) and new (claudeProviderAccount) variable names
    if grep -q "^claudeProviderAccount = " "$CHEZMOI_CONFIG"; then
        sed "s/^claudeProviderAccount = .*/claudeProviderAccount = \"$provider_account\"/" "$CHEZMOI_CONFIG" > "$tmp_file"
    elif grep -q "^claudeProvider = " "$CHEZMOI_CONFIG"; then
        # Migrate old variable name to new
        sed "s/^claudeProvider = .*/claudeProviderAccount = \"$provider_account\"/" "$CHEZMOI_CONFIG" > "$tmp_file"
    else
        # Add new variable if neither exists
        cp "$CHEZMOI_CONFIG" "$tmp_file"
        echo "claudeProviderAccount = \"$provider_account\"" >> "$tmp_file"
    fi
    mv "$tmp_file" "$CHEZMOI_CONFIG"
}

# Check if provider is valid
is_valid_provider() {
    local provider="$1"
    for p in "${PROVIDERS[@]}"; do
        [[ "$p" == "$provider" ]] && return 0
    done
    return 1
}

# Check if provider is third-party (has base_url)
is_third_party() {
    local provider="$1"
    case "$provider" in
{{- range $name, $config := .claude.providers }}
{{- if $config.base_url }}
        {{ $name }}) return 0 ;;
{{- end }}
{{- end }}
        *) return 1 ;;
    esac
}

# Check if token exists in gopass (supports multi-account paths)
# Tries: provider/account/api_key first, then provider/api_key for backward compat
check_token_exists() {
    local provider="$1"
    local account="${2:-default}"

    # Try new path: provider/account/api_key
    if gopass show -o "claude-code/providers/$provider/$account/api_key" &>/dev/null; then
        return 0
    fi

    # For default account, try old path: provider/api_key (backward compat)
    if [[ "$account" == "default" ]]; then
        if gopass show -o "claude-code/providers/$provider/api_key" &>/dev/null; then
            return 0
        fi
    fi

    return 1
}

# List available providers
list_providers() {
    local current current_provider current_account
    current=$(get_current)
    current_provider=$(get_current_provider)
    current_account=$(get_current_account)

    echo -e "${BLUE}Available providers:${NC}"
    echo ""
{{- range $name, $config := .claude.providers }}
    if [[ "{{ $name }}" == "$current_provider" ]]; then
        if [[ "$current_account" == "default" ]]; then
            echo -e "  ${GREEN}✓ {{ $name }}${NC} - {{ $config.model }}"
        else
            echo -e "  ${GREEN}✓ {{ $name }}@${current_account}${NC} - {{ $config.model }}"
        fi
    else
        echo -e "    {{ $name }} - {{ $config.model }}"
    fi
{{- end }}
    echo ""
    if [[ "$current_account" == "default" ]]; then
        echo -e "Current: ${GREEN}$current_provider${NC}"
    else
        echo -e "Current: ${GREEN}$current_provider@$current_account${NC}"
    fi
}

# Show current provider details
show_current() {
    local current current_provider current_account
    current=$(get_current)
    current_provider=$(get_current_provider)
    current_account=$(get_current_account)

    if [[ "$current_account" == "default" ]]; then
        echo -e "${BLUE}Current provider:${NC} ${GREEN}$current_provider${NC}"
    else
        echo -e "${BLUE}Current provider:${NC} ${GREEN}$current_provider@$current_account${NC}"
    fi
    echo ""

    # Show current settings from settings.json
    if [[ -f "$SETTINGS_FILE" ]]; then
        echo "Settings:"
        jq -r '.env | to_entries | .[] | select(.key | startswith("ANTHROPIC") or startswith("_CLAUDE")) | "  \(.key)=\(.value)"' "$SETTINGS_FILE" 2>/dev/null
    fi
}

# Switch to a provider (supports provider@account format)
switch_provider() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        echo -e "${RED}Error: Provider name required${NC}" >&2
        echo "Usage: claude-switch use <provider[@account]>" >&2
        echo ""
        list_providers
        return 1
    fi

    # Parse provider@account
    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        echo ""
        list_providers
        return 1
    fi

    local current
    current=$(get_current)

    # Format target for comparison
    local target
    if [[ "$account" == "default" ]]; then
        target="$provider"
    else
        target="$provider@$account"
    fi

    if [[ "$current" == "$target" ]]; then
        echo -e "${YELLOW}Already using '$target'${NC}"
        return 0
    fi

    # Third-party providers require API token
    if is_third_party "$provider"; then
        if ! check_token_exists "$provider" "$account"; then
            echo -e "${RED}Error: API token not found for '$provider' (account: $account)${NC}" >&2
            if [[ "$account" == "default" ]]; then
                echo -e "Run: ${YELLOW}claude-switch add-key $provider${NC}" >&2
            else
                echo -e "Run: ${YELLOW}claude-switch add-key $provider@$account${NC}" >&2
            fi
            return 1
        fi
    fi

    echo -e "${BLUE}Switching to $target...${NC}"

    # 1. Update chezmoi.toml
    set_provider "$target"
    echo "  ✓ Updated chezmoi.toml"

    # 2. Apply chezmoi to regenerate settings.json
    chezmoi apply "$SETTINGS_FILE"
    echo "  ✓ Applied chezmoi"

    echo ""
    echo -e "${GREEN}✓ Switched to $target${NC}"
    echo -e "${YELLOW}Restart Claude Code to apply changes${NC}"
}

# Add API key for a provider (supports provider@account format)
add_key() {
    local input="${1:-}"

    if [[ -z "$input" ]]; then
        echo -e "${RED}Error: Provider name required${NC}" >&2
        echo "Usage: claude-switch add-key <provider[@account]>" >&2
        return 1
    fi

    # Parse provider@account
    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        list_providers
        return 1
    fi

    if ! command -v gopass &>/dev/null; then
        echo -e "${RED}Error: gopass not found${NC}" >&2
        return 1
    fi

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    echo -e "${BLUE}Adding API key for $display_name${NC}"
    echo -n "API Key: "
    read -rs api_key
    echo ""

    if [[ -z "$api_key" ]]; then
        echo -e "${RED}Error: API key required${NC}" >&2
        return 1
    fi

    # Always use new path format: provider/account/api_key
    echo "$api_key" | gopass insert -f "claude-code/providers/$provider/$account/api_key"
    echo -e "${GREEN}✓ API key saved to gopass${NC}"
}

# Test provider connectivity
test_provider() {
    local input="${1:-}"

    local provider account base_url

    if [[ -z "$input" ]]; then
        # Test current provider
        provider=$(get_current_provider)
        account=$(get_current_account)
    else
        # Parse provider@account
        local parsed
        parsed=$(parse_provider_account "$input")
        provider=$(echo "$parsed" | cut -d'|' -f1)
        account=$(echo "$parsed" | cut -d'|' -f2)
    fi

    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        return 1
    fi

    # Get base_url for provider
    case "$provider" in
{{- range $name, $config := .claude.providers }}
{{- if $config.base_url }}
        {{ $name }}) base_url="{{ $config.base_url }}" ;;
{{- end }}
{{- end }}
        *)
            echo -e "${YELLOW}Provider '$provider' is native Anthropic (uses OAuth)${NC}"
            echo -e "${GREEN}✓ No API key needed${NC}"
            return 0
            ;;
    esac

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    echo -e "${BLUE}Testing $display_name...${NC}"
    echo "  Base URL: $base_url"

    # Check if token exists
    if ! check_token_exists "$provider" "$account"; then
        echo -e "${RED}✗ API token not found${NC}"
        echo -e "Run: ${YELLOW}claude-switch add-key $display_name${NC}"
        return 1
    fi
    echo -e "  ${GREEN}✓ Token found in gopass${NC}"

    # Get the actual token
    local token
    if gopass show -o "claude-code/providers/$provider/$account/api_key" &>/dev/null; then
        token=$(gopass show -o "claude-code/providers/$provider/$account/api_key")
    else
        token=$(gopass show -o "claude-code/providers/$provider/api_key")
    fi

    # Test API connectivity with a simple models endpoint
    echo "  Testing API connectivity..."
    local response http_code
    response=$(curl -sS -w "\n%{http_code}" --max-time 10 \
        -H "Authorization: Bearer $token" \
        -H "anthropic-version: 2023-06-01" \
        "$base_url/v1/models" 2>&1)

    http_code=$(echo "$response" | tail -n1)
    local body
    body=$(echo "$response" | sed '$d')

    case "$http_code" in
        200)
            echo -e "  ${GREEN}✓ API connection successful${NC}"
            ;;
        401)
            echo -e "  ${RED}✗ Authentication failed (invalid API key)${NC}"
            return 1
            ;;
        429)
            echo -e "  ${YELLOW}⚠ Rate limited (429)${NC}"
            echo "  API is reachable but rate limited"
            return 1
            ;;
        000)
            echo -e "  ${RED}✗ Connection failed (network error or timeout)${NC}"
            return 1
            ;;
        *)
            echo -e "  ${YELLOW}⚠ Unexpected response: HTTP $http_code${NC}"
            echo "  Response: $body"
            ;;
    esac

    echo ""
    echo -e "${GREEN}✓ Provider $display_name is working${NC}"
}

# Show help
show_help() {
    cat << 'EOF'
Claude Code Provider Switcher

Usage: claude-switch <command> [args]

Commands:
  list                       List available providers
  current                    Show current provider details
  use <provider[@account]>   Switch to a provider (with optional account)
  add-key <provider[@account]> Add/update API key in gopass
  test [provider[@account]]  Test API connectivity
  help                       Show this help

Examples:
  claude-switch list               # List all providers
  claude-switch use deepseek       # Switch to DeepSeek (default account)
  claude-switch use deepseek@work  # Switch to DeepSeek work account
  claude-switch add-key deepseek@work  # Add API key for work account
  claude-switch test               # Test current provider
  claude-switch test deepseek@work # Test specific provider/account

How it works:
  1. Modifies claudeProviderAccount in ~/.config/chezmoi/chezmoi.toml
  2. Runs chezmoi apply to regenerate ~/.claude/settings.json
  3. Restart Claude Code to apply changes

Providers:
EOF
{{- range $name, $config := .claude.providers }}
  echo "  {{ $name }} - {{ $config.model }}"
{{- end }}
}

# Main
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        list|ls)
            list_providers
            ;;
        current|status)
            show_current
            ;;
        use|switch)
            switch_provider "$@"
            ;;
        add-key|add)
            add_key "$@"
            ;;
        test)
            test_provider "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            # If argument looks like a provider name or provider@account, switch to it
            local parsed_provider
            parsed_provider=$(parse_provider_account "$cmd" | cut -d'|' -f1)
            if is_valid_provider "$parsed_provider"; then
                switch_provider "$cmd"
            else
                echo -e "${RED}Unknown command: $cmd${NC}" >&2
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"
