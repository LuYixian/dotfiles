#!/bin/bash
# Claude Code API Key Helper
# Called by Claude Code via apiKeyHelper to dynamically fetch API token
# Reads current provider@account from chezmoi data and retrieves token from gopass

set -euo pipefail

# Get current provider@account from chezmoi data
get_provider_account() {
    chezmoi data --format json 2>/dev/null | jq -r '.claudeProviderAccount // .claudeProvider // "anthropic"'
}

# Parse provider@account format
# Returns: provider|account
parse_provider_account() {
    local input="$1"
    if [[ "$input" =~ ^([^@]+)@(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    else
        echo "$input|default"
    fi
}

# Get token from gopass (supports multi-account paths)
get_token() {
    local provider="$1"
    local account="$2"

    # Try new path: provider/account/api_key
    if gopass show -o "claude-code/providers/$provider/$account/api_key" 2>/dev/null; then
        return 0
    fi

    # For default account, try old path: provider/api_key (backward compat)
    if [[ "$account" == "default" ]]; then
        if gopass show -o "claude-code/providers/$provider/api_key" 2>/dev/null; then
            return 0
        fi
    fi

    return 1
}

main() {
    local provider_account provider account
    provider_account=$(get_provider_account)

    # Parse provider@account
    local parsed
    parsed=$(parse_provider_account "$provider_account")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    # Check if provider has base_url (third-party)
    local base_url
    base_url=$(chezmoi data --format json 2>/dev/null | jq -r ".claude.providers.$provider.base_url // empty")

    # Native Anthropic providers use OAuth, no token needed
    if [[ -z "$base_url" ]]; then
        exit 0
    fi

    # Third-party providers: get token from gopass
    local token
    token=$(get_token "$provider" "$account") || {
        local display_name
        if [[ "$account" == "default" ]]; then
            display_name="$provider"
        else
            display_name="$provider@$account"
        fi
        echo "Error: API token not found for '$display_name'" >&2
        echo "Run: claude-switch add-key $display_name" >&2
        exit 1
    }

    # Output token (Claude Code reads stdout)
    echo -n "$token"
}

main "$@"
