#!/bin/bash
# GPG Key Restore Script
# Imports GPG keys from backup directory
set -euo pipefail

BACKUP_DIR="${1:-.}"

echo "=== GPG Key Restore ==="
echo "Backup dir: $BACKUP_DIR"
echo ""

# Check files exist
if [[ ! -f "$BACKUP_DIR/private-key.asc" ]]; then
    echo "Error: private-key.asc not found in $BACKUP_DIR"
    echo ""
    echo "Usage: gpg-restore [BACKUP_DIR]"
    echo ""
    echo "Expected files:"
    echo "  - private-key.asc (required)"
    echo "  - public-key.asc (optional)"
    echo "  - ownertrust.txt (optional)"
    exit 1
fi

# Import private key (includes public key)
echo "[1/3] Importing private key..."
gpg --import "$BACKUP_DIR/private-key.asc"

# Import ownertrust if exists
if [[ -f "$BACKUP_DIR/ownertrust.txt" ]]; then
    echo "[2/3] Importing trust database..."
    gpg --import-ownertrust "$BACKUP_DIR/ownertrust.txt"
else
    echo "[2/3] No ownertrust.txt found, skipping..."
    echo "      You may need to set trust manually: gpg --edit-key <KEY_ID> trust"
fi

# Verify
echo "[3/3] Verifying..."
gpg --list-secret-keys

echo ""
echo "=== Restore Complete ==="
echo ""
echo "Next steps:"
echo "  1. gopass clone git@github.com:<user>/password-store.git"
echo "  2. chezmoi init --apply <user>"
