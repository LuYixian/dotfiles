#!/bin/bash
# battery - Display battery status with optional color output
# Usage: battery [--ansi|--tmux|--remain|-r]
#
# Options:
#   --ansi    Output with ANSI colors (for terminal)
#   --tmux    Output with tmux color codes (for status bar)
#   -r, --remain  Show time remaining

BATTERY_DANGER=20

# Get battery percentage
get_battery() {
    local percentage
    if command -v pmset &>/dev/null; then
        percentage=$(pmset -g ps | grep -o '[0-9]\+%' | tr -d '%')
    elif command -v ioreg &>/dev/null; then
        local max_cap cur_cap
        max_cap=$(ioreg -n AppleSmartBattery | awk '/MaxCapacity/{print $5}')
        cur_cap=$(ioreg -n AppleSmartBattery | awk '/CurrentCapacity/{print $5}')
        percentage=$(awk -v cur="$cur_cap" -v max="$max_cap" 'BEGIN{ printf("%d", cur/max*100) }')
    fi

    if [[ -n "$percentage" ]]; then
        echo "${percentage}%"
    fi
}

# Check if battery is charging
is_charging() {
    if command -v pmset &>/dev/null; then
        pmset -g ps | grep -qE "AC Power|charged"
        return $?
    elif command -v ioreg &>/dev/null; then
        ioreg -c AppleSmartBattery | grep -q '"IsCharging" = Yes'
        return $?
    fi
    return 1
}

# Get time remaining
get_remain() {
    local time_remain
    if command -v pmset &>/dev/null; then
        time_remain=$(pmset -g ps | grep -o '[0-9]\+:[0-9]\+')
        if [[ -z "$time_remain" ]]; then
            time_remain="calculating..."
        fi
    else
        time_remain="N/A"
    fi
    echo "$time_remain"
}

# Color output for terminal (ANSI)
battery_color_ansi() {
    local percentage="${1:-$(get_battery)}"
    local level="${percentage%%%*}"

    if is_charging; then
        echo -e "\033[32m${percentage}\033[0m"  # Green when charging
    elif [[ "$level" -lt "$BATTERY_DANGER" ]]; then
        echo -e "\033[31m${percentage}\033[0m"  # Red when low
    else
        echo -e "\033[34m${percentage}\033[0m"  # Blue otherwise
    fi
}

# Color output for tmux
battery_color_tmux() {
    local percentage="${1:-$(get_battery)}"
    local level="${percentage%%%*}"

    if is_charging; then
        echo "#[fg=green]${percentage}#[default]"
    elif [[ "$level" -lt "$BATTERY_DANGER" ]]; then
        echo "#[fg=red]${percentage}#[default]"
    else
        echo "#[fg=blue]${percentage}#[default]"
    fi
}

# Parse arguments
case "$1" in
    -h|--help)
        echo "Usage: battery [--ansi|--tmux|--remain|-r]"
        echo "  --ansi    ANSI colored output"
        echo "  --tmux    tmux colored output"
        echo "  -r        Show time remaining"
        exit 0
        ;;
    --ansi)
        battery_color_ansi
        ;;
    --tmux)
        battery_color_tmux
        ;;
    -r|--remain)
        get_remain
        ;;
    *)
        get_battery
        ;;
esac
