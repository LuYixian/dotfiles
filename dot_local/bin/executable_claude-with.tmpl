#!/bin/bash
# Claude Code Provider Wrapper
# Launch claude with any provider via fzf selection and environment variables
#
# Usage:
#   claude-with                       # fzf interactive picker
#   claude-with deepseek              # Direct launch with provider
#   claude-with deepseek@work         # Direct launch with provider@account
#   claude-with --list                # List all provider@account
#   claude-with kimi -- --resume      # Pass args to claude after --

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Available providers (from chezmoi data)
PROVIDERS=({{- range $name, $_ := .claude.providers }} "{{ $name }}"{{- end }})

# Parse provider@account format
parse_provider_account() {
    local input="$1"
    if [[ "$input" =~ ^([^@]+)@(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    elif [[ "$input" =~ ^([^/]+)/(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    else
        echo "$input|default"
    fi
}

require_cmd() {
    local c
    for c in "$@"; do
        if ! command -v "$c" &>/dev/null; then
            echo -e "${RED}Error:${NC} required command not found: $c" >&2
            return 1
        fi
    done
}

# Check if provider is valid
is_valid_provider() {
    local provider="$1"
    for p in "${PROVIDERS[@]}"; do
        [[ "$p" == "$provider" ]] && return 0
    done
    return 1
}

# Check if provider is third-party (has base_url)
is_third_party() {
    local provider="$1"
    case "$provider" in
{{- range $name, $config := .claude.providers }}
{{- if $config.base_url }}
        {{ $name }}) return 0 ;;
{{- end }}
{{- end }}
        *) return 1 ;;
    esac
}

# Get provider config
get_provider_config() {
    local provider="$1"
    case "$provider" in
{{- range $name, $config := .claude.providers }}
        {{ $name }})
            cat << 'CONFIG_EOF'
{
  "base_url": "{{ index $config "base_url" }}",
  "model": "{{ index $config "model" }}",
  "small_model": "{{ index $config "small_model" }}"{{ if hasKey $config "timeout_ms" }},
  "timeout_ms": "{{ index $config "timeout_ms" }}"{{ end }}{{ if hasKey $config "disable_nonessential_traffic" }},
  "disable_nonessential_traffic": true{{ end }}{{ if hasKey $config "haiku_model" }},
  "haiku_model": "{{ index $config "haiku_model" }}"{{ end }}{{ if hasKey $config "sonnet_model" }},
  "sonnet_model": "{{ index $config "sonnet_model" }}"{{ end }}{{ if hasKey $config "opus_model" }},
  "opus_model": "{{ index $config "opus_model" }}"{{ end }}
}
CONFIG_EOF
            ;;
{{- end }}
    esac
}

# Build provider list with accounts from gopass
build_provider_list() {
    for provider in "${PROVIDERS[@]}"; do
        # List accounts from gopass
        local accounts
        accounts=$(gopass list -f "claude-code/providers/$provider" 2>/dev/null \
            | grep -E '/api_key$' \
            | sed 's|.*/\([^/]*\)/api_key$|\1|' \
            | sort -u) || true

        if [[ -z "$accounts" ]]; then
            # No accounts in gopass, show provider alone
            echo "$provider"
        else
            # Show each account
            while IFS= read -r account; do
                if [[ "$account" == "default" ]]; then
                    echo "$provider"
                else
                    echo "$provider@$account"
                fi
            done <<< "$accounts"
        fi
    done
}

# FZF picker for provider selection
fzf_select_provider() {
    while true; do
        local selected
        selected=$({ echo -e "${GREEN}+ Add new account...${NC}"; build_provider_list; } | fzf --ansi \
            --height=50% \
            --border=rounded \
            --header='Select provider to launch' \
            --preview='
                input={}
                if [[ "$input" == *"Add new"* ]]; then
                    echo -e "\033[1;32mAdd new account\033[0m"
                    echo ""
                    echo "Create a new provider account."
                    echo "Account must not already exist."
                    exit 0
                fi
                provider=$(echo "$input" | cut -d@ -f1)
                account=$(echo "$input" | grep -o "@.*" | cut -c2-)
                account=${account:-default}

                echo -e "\033[1;34mProvider:\033[0m $provider"
                echo -e "\033[1;34mAccount:\033[0m $account"
                echo ""

                # Show config
                claude-token --config "$provider" 2>/dev/null | jq -r "
                    \"Model: \(.model // \"N/A\")\",
                    \"Base URL: \(.base_url // \"Native Anthropic (OAuth)\")\"
                " 2>/dev/null || echo "Config not available"
                echo ""

                # Check token
                if claude-token --check "$input" 2>/dev/null; then
                    echo -e "\033[0;32m✓ Token available\033[0m"
                else
                    if claude-token --config "$provider" 2>/dev/null | jq -e ".base_url // empty" >/dev/null 2>&1; then
                        echo -e "\033[0;31m✗ No token configured\033[0m"
                        echo -e "Run: claude-manage add $input"
                    else
                        echo -e "\033[0;33m○ Native OAuth (no token needed)\033[0m"
                    fi
                fi
            ' \
            --preview-window='right:45%:wrap') || true

        # Handle selection
        if [[ -z "$selected" ]]; then
            echo ""
            return
        elif [[ "$selected" == *"Add new"* ]]; then
            # Delegate to claude-manage for account creation
            claude-manage add
            # Loop back to show picker again
        else
            echo "$selected"
            return
        fi
    done
}

# Launch claude with provider
launch_claude() {
    local provider_account="$1"
    shift  # remaining args for claude

    # Parse provider@account
    local parsed provider account
    parsed=$(parse_provider_account "$provider_account")
    provider="${parsed%%|*}"
    account="${parsed#*|}"

    # Validate provider
    if ! is_valid_provider "$provider"; then
        echo -e "${RED}Error: Unknown provider '$provider'${NC}" >&2
        echo ""
        echo "Available providers:"
        printf '  %s\n' "${PROVIDERS[@]}"
        return 1
    fi

    # Get provider config
    local config base_url model small_model timeout disable_traffic
    config=$(get_provider_config "$provider")
    base_url=$(echo "$config" | jq -r '.base_url // empty')
    model=$(echo "$config" | jq -r '.model // empty')
    small_model=$(echo "$config" | jq -r '.small_model // empty')
    timeout=$(echo "$config" | jq -r '.timeout_ms // empty')
    disable_traffic=$(echo "$config" | jq -r '.disable_nonessential_traffic // empty')

    local display_name
    if [[ "$account" == "default" ]]; then
        display_name="$provider"
    else
        display_name="$provider@$account"
    fi

    # Set environment variables
    if [[ -n "$base_url" ]]; then
        # Third-party provider - need token
        local token
        if ! token=$(claude-token "$display_name" 2>/dev/null); then
            echo -e "${RED}Error: No API token for $display_name${NC}" >&2
            echo -e "Run: ${YELLOW}claude-manage add $display_name${NC}" >&2
            return 1
        fi

        echo -e "${BLUE}Launching claude with $display_name...${NC}"
        echo -e "  Model: $model"
        echo -e "  Base URL: $base_url"
        echo ""

        export ANTHROPIC_API_KEY="$token"
        export ANTHROPIC_BASE_URL="$base_url"
        [[ -n "$model" ]] && export ANTHROPIC_MODEL="$model"
        [[ -n "$small_model" ]] && export ANTHROPIC_SMALL_FAST_MODEL="$small_model"
        [[ -n "$timeout" ]] && export API_TIMEOUT_MS="$timeout"
        [[ "$disable_traffic" == "true" ]] && export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

        # Set model variants if available
        local haiku sonnet opus
        haiku=$(echo "$config" | jq -r '.haiku_model // empty')
        sonnet=$(echo "$config" | jq -r '.sonnet_model // empty')
        opus=$(echo "$config" | jq -r '.opus_model // empty')
        [[ -n "$haiku" ]] && export ANTHROPIC_DEFAULT_HAIKU_MODEL="$haiku"
        [[ -n "$sonnet" ]] && export ANTHROPIC_DEFAULT_SONNET_MODEL="$sonnet"
        [[ -n "$opus" ]] && export ANTHROPIC_DEFAULT_OPUS_MODEL="$opus"
    else
        # Native Anthropic - just set model
        echo -e "${BLUE}Launching claude with $display_name...${NC}"
        echo -e "  Model: $model (Native Anthropic)"
        echo ""

        [[ -n "$model" ]] && export ANTHROPIC_MODEL="$model"
    fi

    exec claude "$@"
}

# List providers
list_providers() {
    echo -e "${BLUE}Available providers:${NC}"
    echo ""
    build_provider_list | while read -r item; do
        local provider
        provider=$(echo "$item" | cut -d@ -f1)
        if is_third_party "$provider"; then
            if claude-token --check "$item" 2>/dev/null; then
                echo -e "  ${GREEN}✓${NC} $item"
            else
                echo -e "  ${RED}✗${NC} $item (no token)"
            fi
        else
            echo -e "  ${GREEN}○${NC} $item (native)"
        fi
    done
}

# Show help
show_help() {
    cat << 'EOF'
Claude Code Provider Wrapper

Usage:
  claude-with                       Interactive fzf picker
  claude-with <provider[@account]>  Launch with specific provider
  claude-with <provider> -- [args]  Launch with claude arguments
  claude-with --list                List available providers

Options:
  --list, -l    List all provider@account combinations
  --help, -h    Show this help

Examples:
  claude-with                    # Open fzf picker, Enter to launch
  claude-with deepseek           # Launch with DeepSeek
  claude-with deepseek@work      # Launch with specific account
  claude-with kimi -- --resume   # Launch Kimi and resume session
EOF
}

# Main
main() {
    require_cmd fzf jq claude-token || exit 1

    local provider_account=""
    local claude_args=()
    local mode="interactive"

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --list|-l)
                mode="list"
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            --)
                shift
                claude_args=("$@")
                break
                ;;
            *)
                if [[ -z "$provider_account" ]]; then
                    provider_account="$1"
                    mode="direct"
                else
                    claude_args+=("$1")
                fi
                shift
                ;;
        esac
    done

    case "$mode" in
        list)
            list_providers
            ;;
        direct)
            launch_claude "$provider_account" "${claude_args[@]}"
            ;;
        interactive)
            local selected
            selected=$(fzf_select_provider)
            if [[ -n "$selected" ]]; then
                launch_claude "$selected" "${claude_args[@]}"
            else
                echo "No provider selected"
                exit 0
            fi
            ;;
    esac
}

main "$@"
