#!/bin/bash
# Claude Code Token Helper
# Unified token fetcher for apiKeyHelper, claude-with, and claude-provider
#
# Usage:
#   claude-token                    # Current provider token (for apiKeyHelper)
#   claude-token deepseek@work      # Specific provider@account token
#   claude-token --check kimi@work  # Check if token exists (exit 0/1)
#   claude-token --config kimi      # Output provider config as JSON

set -euo pipefail

# Parse provider@account format
# Returns: provider|account
parse_provider_account() {
    local input="$1"
    if [[ "$input" =~ ^([^@]+)@(.+)$ ]]; then
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    elif [[ "$input" =~ ^([^/]+)/(.+)$ ]]; then
        # Also accept provider/account (matches gopass folder layout)
        echo "${BASH_REMATCH[1]}|${BASH_REMATCH[2]}"
    else
        echo "$input|default"
    fi
}

# Get current provider@account from chezmoi data
get_provider_account() {
    chezmoi data --format json 2>/dev/null | jq -r '.claudeProviderAccount // .claudeProvider // "anthropic"'
}

# Check if provider has base_url (is third-party)
is_third_party() {
    local provider="$1"
    local base_url
    base_url=$(chezmoi data --format json 2>/dev/null | jq -r ".claude.providers.$provider.base_url // empty")
    [[ -n "$base_url" ]]
}

# Get provider config as JSON
get_provider_config() {
    local provider="$1"
    chezmoi data --format json 2>/dev/null | jq -c ".claude.providers.$provider // {}"
}

# Check if token exists in gopass (non-interactive)
check_token_exists() {
    local provider="$1"
    local account="$2"

    # New path format: provider/account/api_key
    if gopass list -f "claude-code/providers/$provider/$account/api_key" &>/dev/null; then
        return 0
    fi

    # Fallback for default account: provider/api_key (legacy)
    if [[ "$account" == "default" ]]; then
        if gopass list -f "claude-code/providers/$provider/api_key" &>/dev/null; then
            return 0
        fi
    fi

    return 1
}

# Get token from gopass
get_token() {
    local provider="$1"
    local account="$2"

    # Try new path: provider/account/api_key
    if gopass show -o "claude-code/providers/$provider/$account/api_key" 2>/dev/null; then
        return 0
    fi

    # Fallback for default account: provider/api_key (legacy)
    if [[ "$account" == "default" ]]; then
        if gopass show -o "claude-code/providers/$provider/api_key" 2>/dev/null; then
            return 0
        fi
    fi

    return 1
}

# Main
main() {
    local mode="token"
    local input=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --check)
                mode="check"
                shift
                input="${1:-}"
                shift || true
                ;;
            --config)
                mode="config"
                shift
                input="${1:-}"
                shift || true
                ;;
            -h|--help)
                cat << 'EOF'
Claude Code Token Helper

Usage:
  claude-token                    # Current provider token (for apiKeyHelper)
  claude-token deepseek@work      # Specific provider@account token
  claude-token --check kimi@work  # Check if token exists (exit 0/1)
  claude-token --config kimi      # Output provider config as JSON

Options:
  --check <provider[@account]>    Check if token exists (no output, exit code only)
  --config <provider>             Output provider config as JSON
  -h, --help                      Show this help

Exit codes:
  0  Success (token found or config retrieved)
  1  Token not found or error
EOF
                exit 0
                ;;
            *)
                input="$1"
                shift
                ;;
        esac
    done

    # Default to current provider if no input
    if [[ -z "$input" ]]; then
        input=$(get_provider_account)
    fi

    # Parse provider@account
    local parsed provider account
    parsed=$(parse_provider_account "$input")
    provider=$(echo "$parsed" | cut -d'|' -f1)
    account=$(echo "$parsed" | cut -d'|' -f2)

    case "$mode" in
        check)
            # Silent check, exit code only
            if is_third_party "$provider"; then
                check_token_exists "$provider" "$account"
            else
                # Native Anthropic providers don't need tokens
                exit 0
            fi
            ;;
        config)
            # Output provider config as JSON
            get_provider_config "$provider"
            ;;
        token)
            # Native Anthropic providers use OAuth, no token needed
            if ! is_third_party "$provider"; then
                exit 0
            fi

            # Third-party providers: get token from gopass
            local token
            if ! token=$(get_token "$provider" "$account"); then
                local display_name
                if [[ "$account" == "default" ]]; then
                    display_name="$provider"
                else
                    display_name="$provider@$account"
                fi
                echo "Error: API token not found for '$display_name'" >&2
                echo "Run: claude-provider add-key $display_name" >&2
                exit 1
            fi

            # Output token (Claude Code reads stdout)
            echo -n "$token"
            ;;
    esac
}

main "$@"
